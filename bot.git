import os, time, random, json, logging
from threading import Lock
import telebot

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- –¢–û–ö–ï–ù (–í—Å—Ç–∞–≤—å —Å–≤–æ–π –∏–ª–∏ –¥–æ–±–∞–≤—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è) ---
TOKEN = os.getenv("TG_BOT_TOKEN") or "8109307891:AAHSqQtacU_Ar_1srMJisLqD1eEPEXocmls"
bot = telebot.TeleBot(TOKEN)

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã ---
PHONES = [
    ("iPhone 11", 30000), ("iPhone 13", 55000), ("iPhone 15 Pro", 130000), 
    ("Nokia 3310", 150000), ("Samsung S24 Ultra", 125000), ("Xiaomi 14", 80000),
    ("Sony Xperia 1", 90000), ("Motorola RAZR", 110000), ("Pixel 8 Pro", 95000)
]

USERS_FILE = "users.json"
lock = Lock()
_users = {}

# --- –°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏ ---
def load_users():
    global _users
    if os.path.exists(USERS_FILE):
        try:
            with open(USERS_FILE, "r", encoding="utf-8") as f:
                _users = json.load(f)
                logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –±–∞–∑—ã: {e}")
            _users = {}
    else:
        _users = {}
        save_users()

def save_users():
    with lock:
        try:
            with open(USERS_FILE, "w", encoding="utf-8") as f:
                json.dump(_users, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–∑—ã: {e}")

def get_user(m):
    uid = str(m.from_user.id)
    if uid not in _users:
        _users[uid] = {
            "name": m.from_user.first_name or "–ü–µ—Ä–µ–∫—É–ø", 
            "balance": 10000, 
            "inventory": [], 
            "last_flip": 0,
            "exp": 0,
            "lvl": 1
        }
        save_users()
    return _users[uid]

# --- –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ ---
def add_exp(user, amount):
    user["exp"] += amount
    next_lvl = user["lvl"] * 100 # –° –∫–∞–∂–¥—ã–º —É—Ä–æ–≤–Ω–µ–º –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –æ–ø—ã—Ç–∞
    if user["exp"] >= next_lvl:
        user["lvl"] += 1
        user["exp"] = 0
        return True
    return False

# --- –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ ---

@bot.message_handler(commands=['start', 'help'])
def start_cmd(m):
    msg = ("üì± **–î–û–ë–†–û –ü–û–ñ–ê–õ–û–í–ê–¢–¨ –í –°–ò–ú–£–õ–Ø–¢–û–† –ü–ï–†–ï–ö–£–ü–ê!**\n\n"
           "üíµ **–ó–∞—Ä–∞–±–æ—Ç–æ–∫:**\n"
           "‚Ä¢ `–∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å` ‚Äî –ø–æ–π—Ç–∏ –Ω–∞ —Å–º–µ–Ω—É –≤ —Å–µ—Ä–≤–∏—Å\n"
           "‚Ä¢ `–∫–∞—Ä—Ç` ‚Äî –Ω–∞–π—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω (–±–µ—Å–ø–ª–∞—Ç–Ω–æ —Ä–∞–∑ –≤ —á–∞—Å)\n"
           "‚Ä¢ `—Å—Ç–∞–≤–∫–∞ [—Å—É–º–º–∞]` ‚Äî —Ä–∏—Å–∫–Ω—É—Ç—å –≤ –∫–∞–∑–∏–Ω–æ\n\n"
           "üõç **–¢–æ—Ä–≥–æ–≤–ª—è:**\n"
           "‚Ä¢ `–º–∞–≥–∞–∑–∏–Ω` ‚Äî –∫—É–ø–∏—Ç—å –Ω–æ–≤—ã–π –∫–µ–π—Å\n"
           "‚Ä¢ `—Ç–ª` ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—ã\n"
           "‚Ä¢ `–ø—Ä–æ–¥–∞—Ç—å [–Ω–æ–º–µ—Ä]` ‚Äî –∑–∞–≥–Ω–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç—É\n\n"
           "üìä **–ü—Ä–æ—á–µ–µ:**\n"
           "‚Ä¢ `–ø—Ä–æ—Ñ–∏–ª—å` ‚Äî —Ç–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
           "‚Ä¢ `—Ç–æ–ø` ‚Äî —Å–ø–∏—Å–æ–∫ –ª—É—á—à–∏—Ö")
    bot.send_message(m.chat.id, msg, parse_mode="Markdown")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å')
def earn_money(m):
    user = get_user(m)
    base = random.randint(1000, 3000)
    bonus = user["lvl"] * 500
    total = base + bonus
    user["balance"] += total
    save_users()
    bot.send_message(m.chat.id, f"üõ† –¢—ã –ø–æ—á–∏–Ω–∏–ª –ø–∞—Ä—É —ç–∫—Ä–∞–Ω–æ–≤!\n–ü–æ–ª—É—á–µ–Ω–æ: **{total:,}$**\n_(–£—Ä–æ–≤–µ–Ω—å {user['lvl']} –¥–∞–µ—Ç –±–æ–Ω—É—Å +{bonus:,}$)_", parse_mode="Markdown")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–º–∞–≥–∞–∑–∏–Ω')
def open_shop(m):
    bot.send_message(m.chat.id, "üì¶ **–ú–ê–ì–ê–ó–ò–ù –ö–ï–ô–°–û–í**\n\n1. –û–±—ã—á–Ω—ã–π –∫–µ–π—Å (random phone) ‚Äî **15,000$**\n\n–ß—Ç–æ–±—ã –∫—É–ø–∏—Ç—å, –Ω–∞–ø–∏—à–∏: `–∫—É–ø–∏—Ç—å 1`", parse_mode="Markdown")

@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith('–∫—É–ø–∏—Ç—å 1'))
def buy_case(m):
    user = get_user(m)
    if user["balance"] < 15000:
        return bot.send_message(m.chat.id, "‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥! –ò–¥–∏ –∑–∞—Ä–∞–±–æ—Ç–∞–π.")
    
    p_name, p_price = random.choice(PHONES)
    # –®–∞–Ω—Å –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    condition = random.choice(["‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ", "‚úÖ –•–æ—Ä–æ—à–µ–µ", "ü§ï –ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ"])
    mult = {"‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ": 1.1, "‚úÖ –•–æ—Ä–æ—à–µ–µ": 0.8, "ü§ï –ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ": 0.5}[condition]
    final_price = int(p_price * mult)

    user["balance"] -= 15000
    user["inventory"].append({"name": p_name, "price": final_price, "cond": condition})
    save_users()
    bot.send_message(m.chat.id, f"üì¶ –ò–∑ –∫–µ–π—Å–∞ –≤—ã–ø–∞–ª: **{p_name}**\n–°–æ—Å—Ç–æ—è–Ω–∏–µ: {condition}\n–û—Ü–µ–Ω–µ–Ω –≤: **{final_price:,}$**", parse_mode="Markdown")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–∫–∞—Ä—Ç')
def free_claim(m):
    user = get_user(m)
    now = time.time()
    if now - user["last_flip"] < 3600:
        remains = int((3600 - (now - user["last_flip"])) / 60)
        return bot.send_message(m.chat.id, f"‚è≥ –ö–ª–∏–µ–Ω—Ç—ã –ø—Ä–∏–Ω–µ—Å—É—Ç —Å—Ç–∞—Ä—å–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ **{remains} –º–∏–Ω.**", parse_mode="Markdown")

    p_name, p_price = random.choice(PHONES)
    # –° –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–∞–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ –¥–µ—à–µ–≤—ã–µ –ë/–£
    final_price = int(p_price * 0.3)
    user["inventory"].append({"name": f"–ë/–£ {p_name}", "price": final_price, "cond": "‚úÖ –ë/–£"})
    user["last_flip"] = now
    save_users()
    bot.send_message(m.chat.id, f"üéÅ –•–∞–ª—è–≤–∞! –¢—ã –Ω–∞—à–µ–ª: **{p_name}**\n–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: **{final_price:,}$**", parse_mode="Markdown")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '—Ç–ª')
def my_inventory(m):
    user = get_user(m)
    inv = user.get("inventory", [])
    if not inv:
        return bot.send_message(m.chat.id, "üì± –£ —Ç–µ–±—è –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –Ω–∞ –ø—Ä–æ–¥–∞–∂—É.")
    
    msg = f"üì± **–¢–≤–æ–π —Å–∫–ª–∞–¥ (LVL {user['lvl']}):**\n\n"
    for i, item in enumerate(inv, 1):
        msg += f"{i}. {item['name']} ({item['cond']}) ‚Äî **{item['price']:,}$**\n"
    msg += "\n–ß—Ç–æ–±—ã –ø—Ä–æ–¥–∞—Ç—å: `–ø—Ä–æ–¥–∞—Ç—å [–Ω–æ–º–µ—Ä]`"
    bot.send_message(m.chat.id, msg, parse_mode="Markdown")

@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith('–ø—Ä–æ–¥–∞—Ç—å '))
def sell_phone(m):
    user = get_user(m)
    try:
        idx = int(m.text.split()[-1]) - 1
        if idx < 0 or idx >= len(user["inventory"]): raise ValueError
        
        item = user["inventory"].pop(idx)
        user["balance"] += item["price"]
        lvl_up = add_exp(user, 20)
        save_users()
        
        res = f"ü§ù –¢—ã –ø—Ä–æ–¥–∞–ª {item['name']} –∑–∞ **{item['price']:,}$**\n+20 XP –∫ —É—Ä–æ–≤–Ω—é."
        if lvl_up: res += "\n\nüÜô **–£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù! –¢–≤–æ–π –±–æ–Ω—É—Å –∫ —Ä–∞–±–æ—Ç–µ –≤—ã—Ä–æ—Å!**"
        bot.send_message(m.chat.id, res, parse_mode="Markdown")
    except:
        bot.send_message(m.chat.id, "‚ùå –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ `—Ç–ª`. –ù–∞–ø—Ä–∏–º–µ—Ä: `–ø—Ä–æ–¥–∞—Ç—å 1`")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–ø—Ä–æ—Ñ–∏–ª—å')
def profile(m):
    user = get_user(m)
    msg = (f"üë§ **–ò–≥—Ä–æ–∫:** {user['name']}\n"
           f"üí∞ **–ë–∞–ª–∞–Ω—Å:** {user['balance']:,}$\n"
           f"‚≠ê **–£—Ä–æ–≤–µ–Ω—å:** {user['lvl']} ({user['exp']} XP)\n"
           f"üì± **–í –Ω–∞–ª–∏—á–∏–∏:** {len(user['inventory'])} —à—Ç.")
    bot.send_message(m.chat.id, msg, parse_mode="Markdown")

@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith('—Å—Ç–∞–≤–∫–∞ '))
def casino(m):
    user = get_user(m)
    try:
        amount = int(m.text.split()[-1])
        if amount > user["balance"] or amount <= 0:
            return bot.send_message(m.chat.id, "‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç —Å—Ç–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥!")
        
        if random.random() > 0.6: # 40% –Ω–∞ –ø–æ–±–µ–¥—É
            user["balance"] += amount
            bot.send_message(m.chat.id, f"üìà –§–æ—Ä—Ç—É–Ω–∞! –¢—ã –ø–æ–¥–Ω—è–ª **{amount*2:,}$**")
        else:
            user["balance"] -= amount
            bot.send_message(m.chat.id, f"üìâ –°–¥–µ–ª–∫–∞ —Å–æ—Ä–≤–∞–ª–∞—Å—å. –¢—ã –ø–æ—Ç–µ—Ä—è–ª **{amount:,}$**")
        save_users()
    except:
        bot.send_message(m.chat.id, "‚ùå –ü–∏—à–∏: `—Å—Ç–∞–≤–∫–∞ 5000`")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '—Ç–æ–ø')
def top_players(m):
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –±–∞–ª–∞–Ω—Å—É
    top = sorted(_users.values(), key=lambda x: x['balance'], reverse=True)[:10]
    res = "üèÜ **–¢–û–ü 10 –ë–û–ì–ê–¢–´–• –ü–ï–†–ï–ö–£–ü–û–í:**\n\n"
    for i, u in enumerate(top, 1):
        res += f"{i}. {u['name']} ‚Äî **{u['balance']:,}$**\n"
    bot.send_message(m.chat.id, res, parse_mode="Markdown")

# --- –ó–∞–ø—É—Å–∫ ---
if __name__ == "__main__":
    load_users()
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–∂–∞–º!")
    bot.infinity_polling()
