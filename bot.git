import os
import time
import random
import json
import logging
import tempfile
from threading import Lock
import telebot

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- –¢–û–ö–ï–ù (–æ—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ –ø–æ –ø—Ä–æ—Å—å–±–µ) ---
TOKEN = os.getenv("TG_BOT_TOKEN") or "8109307891:AAHSqQtacU_Ar_1srMJisLqD1eEPEXocmls"
bot = telebot.TeleBot(TOKEN, parse_mode="Markdown")

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã ---
# –ö–î –¥–ª—è —Ñ–ª–∏–ø–∞ (3 —á–∞—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
FLIP_COOLDOWN = 3 * 60 * 60  # 3 —á–∞—Å–∞

# –†–ê–°–®–ò–†–ï–ù–ù–´–ô –ø—É–ª —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ (50+ –º–æ–¥–µ–ª–µ–π)
PHONES_POOLS = {
    "–æ–±—ã—á–Ω—ã–π": [
        ("Nokia 3310", 1500),
        ("Siemens A35", 1200),
        ("Philips Xenium", 1800),
        ("Redmi 9A", 2000),
        ("–ñ–µ–∫–∞ —Ñ–æ–Ω (–¥–µ—à—ë–≤—ã–π)", 500),
        ("Alcatel OT-101", 800),
        ("Fly IQ440", 1500),
        ("LG K11", 1700),
        ("ZTE Blade A5", 1400),
        ("HTC Desire 12", 1900),
        ("Nokia 105", 600),
        ("Samsung E1200", 400),
        ("Motorola C117", 300),
        ("Panasonic GD55", 250),
        ("Philips S200", 1100),
        ("Alcatel 1066", 450),
        ("Redmi 8A", 1900),
        ("Realme C11", 1800),
        ("Oppo A15", 2100),
        ("Vivo Y12", 2000),
        ("Honor 7A", 1950),
        ("Lenovo K5", 1850),
        ("Meizu M5", 1750),
        ("ASUS ZenFone Live", 1650),
        ("Micromax Bharat", 800),
    ],
    "–Ω–µ–æ–±—ã—á–Ω—ã–π": [
        ("Xiaomi Redmi Note 10", 8000),
        ("Samsung A12", 7500),
        ("Realme C21", 7000),
        ("Redmi 9A Turbo", 9000),
        ("Motorola Moto G", 8500),
        ("Huawei Y6", 7800),
        ("Nokia 5.3", 8200),
        ("Xiaomi Redmi 9T", 8200),
        ("Samsung A22", 8300),
        ("Realme 7i", 7900),
        ("Oppo A54", 7700),
        ("Vivo Y20", 7300),
        ("Honor 8A", 6800),
        ("LG K52", 7200),
        ("Motorola E7", 6900),
        ("Nokia 3.4", 7100),
        ("Sony Xperia L4", 7600),
        ("ASUS ZenFone Max", 7400),
        ("Google Pixel 4a", 12000),  # –î–æ—Ä–æ–≥–æ–≤–∞—Ç –¥–ª—è –Ω–µ–æ–±—ã—á–Ω–æ–≥–æ, –Ω–æ –ø—É—Å—Ç—å
        ("OnePlus Nord N100", 8100),
        ("Poco M3", 7950),
        ("Infinix Hot 10", 6500),
        ("Tecno Spark 7", 6200),
        ("Blackview A80", 5900),
        ("Ulefone Note 8", 5500),
    ],
    "—Ä–µ–¥–∫–∏–π": [
        ("Xiaomi Mi 11", 25000),
        ("Samsung A52", 24000),
        ("OnePlus Nord", 26000),
        ("Redmi Note 11 Pro", 27000),
        ("Google Pixel 5a", 25500),
        ("Sony Xperia 10", 23000),
        ("Xiaomi 11T", 26500),
        ("Samsung A72", 28000),
        ("Realme 8 Pro", 24500),
        ("Oppo Reno 5", 25000),
        ("Vivo V21", 24000),
        ("Honor 50", 26000),
        ("Motorola Edge 20", 27500),
        ("Nokia X20", 23500),
        ("LG Velvet", 22500),
        ("ASUS ZenFone 8", 29000),
        ("Poco F3", 25500),
        ("Infinix Zero 8", 19000),
        ("Tecno Camon 17", 17000),
        ("Blackview BV7100", 15000),
        ("Ulefone Power Armor", 18000),
        ("Doogee S88 Pro", 16500),
        ("Cubot KingKong", 14500),
        ("Oukitel WP15", 17500),
        ("AGM H5", 18500),
    ],
    "—ç–ø–∏–∫": [
        ("iPhone 12", 55000),
        ("Samsung S21", 58000),
        ("Xiaomi 12 Pro", 60000),
        ("OnePlus 10", 59000),
        ("Asus ROG Phone", 62000),
        ("iPhone 13 mini", 65000),
        ("Samsung S22", 63000),
        ("Xiaomi 12", 56000),
        ("Google Pixel 6", 57000),
        ("Sony Xperia 5 III", 61000),
        ("Motorola Edge 30 Pro", 58500),
        ("Nokia G50", 35000),  # –ß—É—Ç—å –¥–µ—à–µ–≤–ª–µ
        ("LG Wing", 52000),
        ("ASUS ROG Phone 5", 64000),
        ("Poco F4 GT", 51000),
        ("Black Shark 4", 53000),
        ("Red Magic 6", 54500),
        ("ZTE Axon 30", 47000),
        ("Oppo Find X3", 59500),
        ("Vivo X60 Pro", 56500),
        ("Honor Magic 3", 60500),
        ("Realme GT", 54000),
        ("Meizu 18", 52500),
        ("Lenovo Legion Duel", 58000),
        ("Nubia Red Magic", 55000),
    ],
    "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π": [
        ("iPhone 15 Pro Max", 140000),
        ("Samsung S24 Ultra", 135000),
        ("–ê–Ω–¥—Ä—é—à–∫–∞ —Ñ–æ–Ω (—Ä–µ–¥–∫–∏–π –¥–æ—Ä–æ–≥–æ–π)", 200000),
        ("Custom Titanium Pro", 180000),
        ("Sony Xperia Pro-I", 150000),
        ("Google Pixel 8 Pro", 130000),
        ("iPhone 14 Pro Max", 125000),
        ("Samsung S23 Ultra", 120000),
        ("Xiaomi 13 Ultra", 115000),
        ("OnePlus 11 Pro", 110000),
        ("ASUS ROG Phone 7", 105000),
        ("Huawei Mate 60 Pro", 145000),
        ("Honor Magic 5 Pro", 118000),
        ("Oppo Find N2", 155000),
        ("Vivo X90 Pro+", 128000),
        ("Motorola Razr 2023", 132000),
        ("Nothing Phone 2", 95000),
        ("Redmi K60 Pro", 85000),
        ("Realme GT3", 89000),
        ("Poco F5 Pro", 82000),
        ("ZTE Axon 40 Ultra", 98000),
        ("Nubia Z50 Ultra", 102000),
        ("Meizu 20 Pro", 88000),
        ("Lenovo Legion Y90", 92000),
        ("Black Shark 5 Pro", 86000),
    ],
}

# –¶–µ–Ω—ã –Ω–∞ –ø–æ–∫—É–ø–∫—É —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
RARITY_PRICES = {
    "–æ–±—ã—á–Ω—ã–π": 800,
    "–Ω–µ–æ–±—ã—á–Ω—ã–π": 2500,
    "—Ä–µ–¥–∫–∏–π": 8000,
    "—ç–ø–∏–∫": 20000,
    "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π": 50000,
}

# –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
COND_MULT = {
    "‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ": 1.3,
    "‚úÖ –•–æ—Ä–æ—à–µ–µ": 1.0,
    "ü§î –ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ": 0.6,
    "üí© –£–±–∏—Ç–æ–µ": 0.3,
    "üÜï –ù–æ–≤–æ–µ": 1.5,
    "üì¶ –ó–∞–ø–µ—á–∞—Ç–∞–Ω–Ω–æ–µ": 1.8,      # –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    "üîß –ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞": 0.7,      # –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    "üíé –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ": 2.0,      # –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Ä–µ–¥–∫–æ)
}

# –í—Å–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã –¥–ª—è –∫–µ–π—Å–æ–≤ (—Ç–æ–ª—å–∫–æ –±—é–¥–∂–µ—Ç–Ω—ã–µ, –º–∞–∫—Å–∏–º—É–º 15000)
CASE_PHONES = [
    ("Nokia 3310", 1500),
    ("Siemens A35", 1200),
    ("Philips Xenium", 1800),
    ("Redmi 9A", 2000),
    ("–ñ–µ–∫–∞ —Ñ–æ–Ω", 500),
    ("Alcatel OT-101", 800),
    ("Fly IQ440", 1500),
    ("Xiaomi Redmi Note 10", 4000),
    ("Samsung A12", 3800),
    ("Realme C21", 3500),
    ("Motorola Moto G", 4000),
    ("Huawei Y6", 3900),
    ("Nokia 5.3", 4100),
    ("LG K11", 1700),
    ("ZTE Blade A5", 1400),
    ("HTC Desire 12", 1900),
    ("Nokia 105", 600),
    ("Samsung E1200", 400),
    ("Motorola C117", 300),
    ("Panasonic GD55", 250),
    ("Philips S200", 1100),
    ("Alcatel 1066", 450),
    ("Redmi 8A", 1900),
    ("Realme C11", 1800),
    ("Oppo A15", 2100),
    ("Vivo Y12", 2000),
    ("Honor 7A", 1950),
    ("Lenovo K5", 1850),
    ("Meizu M5", 1750),
    ("ASUS ZenFone Live", 1650),
    ("Micromax Bharat", 800),
    ("Xiaomi Redmi 9T", 3200),
    ("Samsung A22", 3800),
    ("Realme 7i", 3500),
    ("Oppo A54", 3400),
    ("Vivo Y20", 3300),
    ("Honor 8A", 2900),
    ("LG K52", 3100),
    ("Motorola E7", 3000),
    ("Nokia 3.4", 3200),
    ("Sony Xperia L4", 3600),
    ("ASUS ZenFone Max", 3400),
    ("Poco M3", 3700),
    ("Infinix Hot 10", 2800),
    ("Tecno Spark 7", 2600),
    ("Blackview A80", 2400),
    ("Ulefone Note 8", 2200),
]

PHRASES = [
    "üé∞ –§–ª–∏–ø!",
    "üîÑ –ö—Ä—É—Ç–∏–º!",
    "üé≤ –£–¥–∞—á–∞ —Å–µ–≥–æ–¥–Ω—è —Å —Ç–æ–±–æ–π!",
    "‚≠ê –î–∂–µ–∫–ø–æ—Ç?",
    "üí∞ –ë–æ–≥–∞—Ç—Å—Ç–≤–æ –±–ª–∏–∑–∫–æ!",
    "üçÄ –í–µ–∑–µ–Ω–∏–µ!",
    "‚ú® –ú–∞–≥–∏—è —Ñ–ª–∏–ø–∞!",
    "üéØ –í —è–±–ª–æ—á–∫–æ!",
    "üí´ –§–æ—Ä—Ç—É–Ω–∞ —É–ª—ã–±–∞–µ—Ç—Å—è!",
    "üî• –ì–æ—Ä—è—á–∏–π —Ñ–ª–∏–ø!",
]

USERS_FILE = "users.json"
lock = Lock()
_users = {}

# --- –°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏ (–∞—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å) ---

def load_users():
    global _users
    if os.path.exists(USERS_FILE):
        try:
            with open(USERS_FILE, "r", encoding="utf-8") as f:
                _users = json.load(f)
            logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –±–∞–∑—ã: {e}")
            _users = {}
    else:
        _users = {}
        save_users()


def save_users():
    with lock:
        try:
            dirn = os.path.dirname(os.path.abspath(USERS_FILE)) or "."
            fd, tmp_path = tempfile.mkstemp(dir=dirn)
            with os.fdopen(fd, "w", encoding="utf-8") as f:
                json.dump(_users, f, ensure_ascii=False, indent=2)
            os.replace(tmp_path, USERS_FILE)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–∑—ã: {e}")


def get_user(m):
    uid = str(m.from_user.id)
    if uid not in _users:
        _users[uid] = {
            "name": m.from_user.first_name or "–ü–µ—Ä–µ–∫—É–ø",
            "balance": 5000,
            "inventory": [],
            "last_flip": 0,
            "exp": 0,
            "lvl": 1,
        }
        save_users()
    return _users[uid]


# --- –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ ---

def add_exp(user, amount):
    user["exp"] += amount
    next_lvl = user["lvl"] * 150
    if user["exp"] >= next_lvl:
        user["lvl"] += 1
        user["exp"] = 0
        return True
    return False


def can_flip(user):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø—Ä–æ—à–µ–ª –ª–∏ –ö–î –¥–ª—è —Ñ–ª–∏–ø–∞"""
    current_time = int(time.time())
    time_passed = current_time - user["last_flip"]
    if time_passed >= FLIP_COOLDOWN:
        return True, 0
    else:
        remaining = FLIP_COOLDOWN - time_passed
        hours = remaining // 3600
        minutes = (remaining % 3600) // 60
        return False, f"{hours}—á {minutes}–º"


# --- –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ ---

@bot.message_handler(commands=["start", "help"])
def start_cmd(m):
    msg = (
        "üì± *–î–û–ë–†–û –ü–û–ñ–ê–õ–û–í–ê–¢–¨ –í –°–ò–ú–£–õ–Ø–¢–û–† –ü–ï–†–ï–ö–£–ü–ê!*\n\n"
        "üé∞ *–§–õ–ò–ü (–û–°–ù–û–í–ù–û–ô –ó–ê–†–ê–ë–û–¢–û–ö):*\n"
        "‚Ä¢ `–∫–∞—Ä—Ç` –∏–ª–∏ `—Ñ–ª–∏–ø` ‚Äî –∫—Ä—É—Ç–∏—Ç—å —Ñ–ª–∏–ø —Ä–∞–∑ –≤ 3 —á–∞—Å–∞! –í—ã–ø–∞–¥–∞–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å\n\n"
        "üõí *–ú–∞–≥–∞–∑–∏–Ω / –¢–æ—Ä–≥–æ–≤–ª—è:*\n"
        "‚Ä¢ `–º–∞–≥–∞–∑–∏–Ω` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω (–∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ –∏–ª–∏ –∫–µ–π—Å)\n"
        "‚Ä¢ `–∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω [—Ä–µ–¥–∫–æ—Å—Ç—å]` ‚Äî –∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏\n"
        "‚Ä¢ `–∫—É–ø–∏—Ç—å –∫–µ–π—Å` –∏–ª–∏ `–∫—É–ø–∏—Ç—å 1` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å (5,000$)\n"
        "‚Ä¢ `—Ç–ª` ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—ã\n"
        "‚Ä¢ `–ø—Ä–æ–¥–∞—Ç—å [–Ω–æ–º–µ—Ä]` ‚Äî –ø—Ä–æ–¥–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `–ø—Ä–æ–¥–∞—Ç—å 1`)\n\n"
        "üìä *–ü—Ä–æ—á–µ–µ:*\n"
        "‚Ä¢ `–ø—Ä–æ—Ñ–∏–ª—å` ‚Äî —Ç–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
        "‚Ä¢ `—Ç–æ–ø` ‚Äî —Å–ø–∏—Å–æ–∫ –ª—É—á—à–∏—Ö\n\n"
        "üéÆ *–í—Å–µ–≥–æ –≤ –∏–≥—Ä–µ –±–æ–ª–µ–µ 50 –º–æ–¥–µ–ª–µ–π —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤!*"
    )
    bot.send_message(m.chat.id, msg)


@bot.message_handler(func=lambda m: m.text and m.text.lower() == "–º–∞–≥–∞–∑–∏–Ω")
def open_shop(m):
    msg = "üõí *–ú–ê–ì–ê–ó–ò–ù*\n\n–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –∫—É–ø–∏—Ç—å:\n"
    msg += "‚Ä¢ `–∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω [—Ä–µ–¥–∫–æ—Å—Ç—å]` ‚Äî –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–¥–∫–æ—Å—Ç–∏: –æ–±—ã—á–Ω—ã–π, –Ω–µ–æ–±—ã—á–Ω—ã–π, —Ä–µ–¥–∫–∏–π, —ç–ø–∏–∫, –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π\n"
    msg += "‚Ä¢ `–∫—É–ø–∏—Ç—å –∫–µ–π—Å` ‚Äî –û–±—ã—á–Ω—ã–π –∫–µ–π—Å (random phone) ‚Äî *5,000$*\n\n"
    msg += "–¶–µ–Ω—ã –Ω–∞ –ø–æ–∫—É–ø–∫—É —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏:\n"
    for r, p in RARITY_PRICES.items():
        msg += f"‚Ä¢ *{r.title()}* ‚Äî *{p:,}$*\n"
    bot.send_message(m.chat.id, msg)


@bot.message_handler(
    func=lambda m: m.text
    and (
        m.text.lower().startswith("–∫—É–ø–∏—Ç—å 1")
        or m.text.lower().startswith("–∫—É–ø–∏—Ç—å –∫–µ–π—Å")
        or m.text.lower() == "–∫—É–ø–∏—Ç—å –∫–µ–π—Å"
    )
)
def buy_case(m):
    user = get_user(m)
    cost = 5000
    if user["balance"] < cost:
        return bot.send_message(m.chat.id, "‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥! –ò–¥–∏ —Ñ–ª–∏–ø–∞–π.")
    
    p_name, p_price = random.choice(CASE_PHONES)
    condition = random.choice(["üÜï –ù–æ–≤–æ–µ", "‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ", "‚úÖ –•–æ—Ä–æ—à–µ–µ", "ü§î –ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ", "üí© –£–±–∏—Ç–æ–µ", "üîß –ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞"])
    mult = COND_MULT.get(condition, 1.0)
    final_price = int(p_price * mult)
    
    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∏–∑ –∫–µ–π—Å–∞ - 15000
    if final_price > 15000:
        final_price = 15000
    
    user["balance"] -= cost
    user["inventory"].append({"name": p_name, "price": final_price, "cond": condition})
    save_users()
    bot.send_message(
        m.chat.id,
        f"üéÅ –ò–∑ –∫–µ–π—Å–∞ –≤—ã–ø–∞–ª: *{p_name}*\n–°–æ—Å—Ç–æ—è–Ω–∏–µ: {condition}\n–û—Ü–µ–Ω–µ–Ω –≤: *{final_price:,}$*",
    )


@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith("–∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω"))
def buy_phone(m):
    user = get_user(m)
    parts = m.text.lower().split()
    if len(parts) < 3:
        return bot.send_message(m.chat.id, "‚ùå –ù–∞–ø–∏—à–∏: `–∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω [—Ä–µ–¥–∫–æ—Å—Ç—å]` (–Ω–∞–ø—Ä–∏–º–µ—Ä: `–∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –æ–±—ã—á–Ω—ã–π`)")
    rarity = parts[-1]
    if rarity not in RARITY_PRICES:
        return bot.send_message(m.chat.id, "‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Ä–µ–¥–∫–æ—Å—Ç—å. –î–æ—Å—Ç—É–ø–Ω—ã–µ: –æ–±—ã—á–Ω—ã–π, –Ω–µ–æ–±—ã—á–Ω—ã–π, —Ä–µ–¥–∫–∏–π, —ç–ø–∏–∫, –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π")
    cost = RARITY_PRICES[rarity]
    if user["balance"] < cost:
        return bot.send_message(m.chat.id, f"‚ùå –î–ª—è –ø–æ–∫—É–ø–∫–∏ {rarity} —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω—É–∂–Ω–æ {cost:,}$ (—É —Ç–µ–±—è {user['balance']:,}$)")
    pool = PHONES_POOLS.get(rarity, [])
    if not pool:
        return bot.send_message(m.chat.id, "‚ùå –í —ç—Ç–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏ —Å–µ–π—á–∞—Å –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (–æ—à–∏–±–∫–∞).")
    base_name, base_price = random.choice(pool)
    
    # –°–æ—Å—Ç–æ—è–Ω–∏—è —Å —à–∞–Ω—Å–∞–º–∏
    conditions = ["üÜï –ù–æ–≤–æ–µ", "‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ", "‚úÖ –•–æ—Ä–æ—à–µ–µ", "ü§î –ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ", "üí© –£–±–∏—Ç–æ–µ", "üîß –ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞", "üíé –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ"]
    weights = [5, 15, 40, 25, 5, 8, 2]  # 2% –Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ
    condition = random.choices(conditions, weights=weights)[0]
    
    mult = COND_MULT.get(condition, 1.0)
    final_price = int(base_price * mult)
    user["balance"] -= cost
    user["inventory"].append({"name": base_name, "price": final_price, "cond": condition})
    add_exp(user, 10)
    save_users()
    bot.send_message(
        m.chat.id,
        f"üõçÔ∏è –¢—ã –∫—É–ø–∏–ª {rarity} —Ç–µ–ª–µ—Ñ–æ–Ω: *{base_name}*\n–°–æ—Å—Ç–æ—è–Ω–∏–µ: {condition}\n–û—Ü–µ–Ω–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏: *{final_price:,}$*\n–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏: *{cost:,}$*",
    )


@bot.message_handler(func=lambda m: m.text and m.text.lower() in ["–∫–∞—Ä—Ç", "—Ñ–ª–∏–ø"])
def flip_feature(m):
    user = get_user(m)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ö–î
    can, remaining = can_flip(user)
    if not can:
        return bot.send_message(m.chat.id, f"‚è≥ –§–ª–∏–ø –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑: *{remaining}*")
    
    # –í—ã–±–æ—Ä —Å–ª—É—á–∞–π–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏ —Å –≤–µ—Å–∞–º–∏
    rarities = ["–æ–±—ã—á–Ω—ã–π", "–Ω–µ–æ–±—ã—á–Ω—ã–π", "—Ä–µ–¥–∫–∏–π", "—ç–ø–∏–∫", "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π"]
    weights = [50, 25, 15, 7, 3]
    chosen_rarity = random.choices(rarities, weights=weights)[0]
    
    # –í—ã–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ –ø—É–ª–∞
    pool = PHONES_POOLS[chosen_rarity]
    base_name, base_price = random.choice(pool)
    
    # –°–æ—Å—Ç–æ—è–Ω–∏—è —Å —à–∞–Ω—Å–∞–º–∏
    conditions = ["üÜï –ù–æ–≤–æ–µ", "‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ", "‚úÖ –•–æ—Ä–æ—à–µ–µ", "ü§î –ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ", "üí© –£–±–∏—Ç–æ–µ", "üîß –ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞", "üì¶ –ó–∞–ø–µ—á–∞—Ç–∞–Ω–Ω–æ–µ", "üíé –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ"]
    weights = [8, 15, 35, 25, 5, 7, 3, 2]  # 2% –Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ, 3% –Ω–∞ –∑–∞–ø–µ—á–∞—Ç–∞–Ω–Ω–æ–µ
    condition = random.choices(conditions, weights=weights)[0]
    
    mult = COND_MULT.get(condition, 1.0)
    final_price = int(base_price * mult)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
    user["inventory"].append({"name": base_name, "price": final_price, "cond": condition})
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ñ–ª–∏–ø–∞
    user["last_flip"] = int(time.time())
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—ã—Ç
    lvl_up = add_exp(user, 30)
    
    save_users()
    
    # –§—Ä–∞–∑–æ—á–∫–∞
    phrase = random.choice(PHRASES)
    
    msg = (
        f"{phrase}\n\n"
        f"üì± –¢–µ–±–µ –≤—ã–ø–∞–ª: *{base_name}*\n"
        f"üè∑Ô∏è –†–µ–¥–∫–æ—Å—Ç—å: *{chosen_rarity.title()}*\n"
        f"üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: {condition}\n"
        f"üí∞ –¶–µ–Ω–∞: *{final_price:,}$*\n\n"
        f"‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å (`—Ç–ª`)\n"
        f"‚è≥ –°–ª–µ–¥—É—é—â–∏–π —Ñ–ª–∏–ø —á–µ—Ä–µ–∑ 3 —á–∞—Å–∞"
    )
    
    if lvl_up:
        msg += "\n\nüèÜ *–£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù!*"
    
    # –†–µ–¥–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ - –¥–≤–æ–π–Ω–æ–π —Ñ–ª–∏–ø (2% —à–∞–Ω—Å)
    if random.random() < 0.02 and chosen_rarity != "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π":
        time.sleep(1)  # –ü–∞—É–∑–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
        # –í—Ç–æ—Ä–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω
        second_rarity = random.choices(rarities, weights=weights)[0]
        second_pool = PHONES_POOLS[second_rarity]
        second_name, second_price = random.choice(second_pool)
        second_condition = random.choices(conditions, weights=weights)[0]
        second_mult = COND_MULT.get(second_condition, 1.0)
        second_final = int(second_price * second_mult)
        
        user["inventory"].append({"name": second_name, "price": second_final, "cond": second_condition})
        save_users()
        
        msg += f"\n\nüéä *–ë–û–ù–£–°! –î–í–û–ô–ù–û–ô –§–õ–ò–ü!*\nüì± +{second_name} ({second_condition}) ‚Äî *{second_final:,}$*"
    
    bot.send_message(m.chat.id, msg)


@bot.message_handler(func=lambda m: m.text and m.text.lower() == "—Ç–ª")
def my_inventory(m):
    user = get_user(m)
    inv = user.get("inventory", [])
    if not inv:
        return bot.send_message(m.chat.id, "üì± –£ —Ç–µ–±—è –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –Ω–∞ –ø—Ä–æ–¥–∞–∂—É.")
    
    # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–µ–Ω–µ (–¥–æ—Ä–æ–≥–∏–µ —Å–≤–µ—Ä—Ö—É)
    sorted_inv = sorted(inv, key=lambda x: x['price'], reverse=True)
    
    msg = f"üì± *–¢–≤–æ–π —Å–∫–ª–∞–¥ (LVL {user['lvl']}):*\n\n"
    total_value = sum(item['price'] for item in inv)
    
    for i, item in enumerate(sorted_inv, 1):
        msg += f"{i}. {item['name']} ({item['cond']}) ‚Äî *{item['price']:,}$*\n"
    
    msg += f"\nüí∞ *–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:* {total_value:,}$"
    msg += "\n\n–ß—Ç–æ–±—ã –ø—Ä–æ–¥–∞—Ç—å: `–ø—Ä–æ–¥–∞—Ç—å [–Ω–æ–º–µ—Ä]` (–Ω—É–º–µ—Ä–∞—Ü–∏—è –ø–æ —Ü–µ–Ω–µ)"
    bot.send_message(m.chat.id, msg)


@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith("–ø—Ä–æ–¥–∞—Ç—å "))
def sell_phone(m):
    user = get_user(m)
    try:
        idx = int(m.text.split()[-1]) - 1
        if idx < 0 or idx >= len(user["inventory"]):
            raise ValueError
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –≤ —Ç–ª
        sorted_inv = sorted(user["inventory"], key=lambda x: x['price'], reverse=True)
        item_to_sell = sorted_inv[idx]
        
        # –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        for i, item in enumerate(user["inventory"]):
            if item['name'] == item_to_sell['name'] and item['price'] == item_to_sell['price'] and item['cond'] == item_to_sell['cond']:
                user["inventory"].pop(i)
                break
        
        user["balance"] += item_to_sell['price']
        lvl_up = add_exp(user, 20)
        save_users()
        
        # –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è —Ä–µ–¥–∫–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
        bonus_text = ""
        if item_to_sell['cond'] == "üíé –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ":
            bonus_text = " üèÜ –†–µ–¥–∫–∞—è –ø—Ä–æ–¥–∞–∂–∞!"
        elif item_to_sell['cond'] == "üì¶ –ó–∞–ø–µ—á–∞—Ç–∞–Ω–Ω–æ–µ":
            bonus_text = " üì¶ –¶–µ–Ω–∞ –∫–∞–∫ –∑–∞ –Ω–æ–≤–æ–µ!"
        
        res = f"ü§ù –¢—ã –ø—Ä–æ–¥–∞–ª {item_to_sell['name']} –∑–∞ *{item_to_sell['price']:,}$*{bonus_text}\n+20 XP –∫ —É—Ä–æ–≤–Ω—é."
        if lvl_up:
            res += "\n\nüèÜ *–£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù! –¢–≤–æ–π —É—Ä–æ–≤–µ–Ω—å –≤—ã—Ä–æ—Å!*"
        bot.send_message(m.chat.id, res)
    except Exception:
        bot.send_message(m.chat.id, "‚ùå –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ `—Ç–ª`. –ù–∞–ø—Ä–∏–º–µ—Ä: `–ø—Ä–æ–¥–∞—Ç—å 1`")


@bot.message_handler(func=lambda m: m.text and m.text.lower() == "–ø—Ä–æ—Ñ–∏–ª—å")
def profile(m):
    user = get_user(m)
    
    # –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ–ª–∏–ø–∞
    can, remaining = can_flip(user)
    flip_status = "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω" if can else f"‚è≥ –ß–µ—Ä–µ–∑: {remaining}"
    
    # –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    total_value = sum(item['price'] for item in user['inventory'])
    
    msg = (
        f"üë§ *–ò–≥—Ä–æ–∫:* {user['name']}\n"
        f"üí∞ *–ë–∞–ª–∞–Ω—Å:* {user['balance']:,}$\n"
        f"üì¶ *–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å:* {len(user['inventory'])} —à—Ç. (üíé {total_value:,}$)\n"
        f"‚≠ê *–£—Ä–æ–≤–µ–Ω—å:* {user['lvl']} ({user['exp']} XP)\n"
        f"üé∞ *–§–ª–∏–ø:* {flip_status}"
    )
    bot.send_message(m.chat.id, msg)


@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith("—Å—Ç–∞–≤–∫–∞ "))
def casino(m):
    user = get_user(m)
    try:
        amount = int(m.text.split()[-1])
        if amount <= 0 or amount > user["balance"]:
            return bot.send_message(m.chat.id, "‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç —Å—Ç–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞!")
        user["balance"] -= amount
        if random.random() < 0.4:
            win = amount * 2
            user["balance"] += win
            bot.send_message(m.chat.id, f"üìà –§–æ—Ä—Ç—É–Ω–∞! –¢—ã –≤—ã–∏–≥—Ä–∞–ª ‚Äî –ø–æ–ª—É—á–∏–ª *{win:,}$*")
        else:
            bot.send_message(m.chat.id, f"üìâ –°–¥–µ–ª–∫–∞ —Å–æ—Ä–≤–∞–ª–∞—Å—å. –¢—ã –ø–æ—Ç–µ—Ä—è–ª *{amount:,}$*")
        save_users()
    except Exception:
        bot.send_message(m.chat.id, "‚ùå –ü–∏—à–∏: `—Å—Ç–∞–≤–∫–∞ 5000`")


@bot.message_handler(func=lambda m: m.text and m.text.lower() == "—Ç–æ–ø")
def top_players(m):
    top = sorted(_users.values(), key=lambda x: x['balance'], reverse=True)[:10]
    res = "üèÖ *–¢–û–ü 10 –ë–û–ì–ê–¢–´–• –ü–ï–†–ï–ö–£–ü–û–í:*\n\n"
    for i, u in enumerate(top, 1):
        # –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –¥–ª—è —Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤
        inv_value = sum(item['price'] for item in u.get('inventory', []))
        total_wealth = u['balance'] + inv_value
        res += f"{i}. {u['name']} ‚Äî *{u['balance']:,}$* (üíé {inv_value:,}$) LVL {u['lvl']}\n"
    bot.send_message(m.chat.id, res)


# --- –ó–∞–ø—É—Å–∫ ---
if __name__ == "__main__":
= sorted(_users.values(), key=lambda x: x['balance'], reverse=True)[:10]
    res = "üèÖ *–¢–û–ü 10 –ë–û–ì–ê–¢–´–• –ü–ï–†–ï–ö–£–ü–û–í:*\n\n"
    for i, u in enumerate(top, 1):
        res += f"{i}. {u['name']} ‚Äî *{u['balance']:,}$*\n"
    bot.send_message(m.chat.id, res)


# --- –ó–∞–ø—É—Å–∫ ---
if __name__ == "__main__":
    load_users()
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–∂–∞–º!")
    while True:
        try:
            bot.infinity_polling(skip_pending=True)
        except Exception:
            logger.exception("Polling —É–ø–∞–ª ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 15 —Å–µ–∫.")
            time.sleep(15)
