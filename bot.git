import os
import time
import random
import json
import logging
import tempfile
from threading import Lock
import telebot
from telebot import types

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- –¢–û–ö–ï–ù ---
TOKEN = os.getenv("TG_BOT_TOKEN") or "8109307891:AAHSqQtacU_Ar_1srMJisLqD1eEPEXocmls"
bot = telebot.TeleBot(TOKEN, parse_mode="Markdown")

# --- –ê–î–ú–ò–ù (–¢–û–õ–¨–ö–û –≠–¢–û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ú–û–ñ–ï–¢ –°–û–•–†–ê–ù–Ø–¢–¨/–ó–ê–ì–†–£–ñ–ê–¢–¨) ---
ADMIN_USERNAME = "MATERbBOGOV1"  # –ë–µ–∑ @
ADMIN_ID = 123456789  # –ó–ê–ú–ï–ù–ò –ù–ê –†–ï–ê–õ–¨–ù–´–ô ID –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø MATERbBOGOV1!

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã ---
FLIP_COOLDOWN = 3 * 60 * 60  # 3 —á–∞—Å–∞

# –ü—É–ª —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ (50+ –º–æ–¥–µ–ª–µ–π)
PHONES_POOLS = {
    "–æ–±—ã—á–Ω—ã–π": [
        ("Nokia 3310", 1500), ("Siemens A35", 1200), ("Philips Xenium", 1800),
        ("Redmi 9A", 2000), ("–ñ–µ–∫–∞ —Ñ–æ–Ω (–¥–µ—à—ë–≤—ã–π)", 500), ("Alcatel OT-101", 800),
        ("Fly IQ440", 1500), ("LG K11", 1700), ("ZTE Blade A5", 1400),
        ("HTC Desire 12", 1900), ("Nokia 105", 600), ("Samsung E1200", 400),
        ("Motorola C117", 300), ("Panasonic GD55", 250), ("Philips S200", 1100),
        ("Alcatel 1066", 450), ("Redmi 8A", 1900), ("Realme C11", 1800),
        ("Oppo A15", 2100), ("Vivo Y12", 2000), ("Honor 7A", 1950),
        ("Lenovo K5", 1850), ("Meizu M5", 1750), ("ASUS ZenFone Live", 1650),
        ("Micromax Bharat", 800),
    ],
    "–Ω–µ–æ–±—ã—á–Ω—ã–π": [
        ("Xiaomi Redmi Note 10", 8000), ("Samsung A12", 7500), ("Realme C21", 7000),
        ("Redmi 9A Turbo", 9000), ("Motorola Moto G", 8500), ("Huawei Y6", 7800),
        ("Nokia 5.3", 8200), ("Xiaomi Redmi 9T", 8200), ("Samsung A22", 8300),
        ("Realme 7i", 7900), ("Oppo A54", 7700), ("Vivo Y20", 7300),
        ("Honor 8A", 6800), ("LG K52", 7200), ("Motorola E7", 6900),
        ("Nokia 3.4", 7100), ("Sony Xperia L4", 7600), ("ASUS ZenFone Max", 7400),
        ("Google Pixel 4a", 12000), ("OnePlus Nord N100", 8100), ("Poco M3", 7950),
        ("Infinix Hot 10", 6500), ("Tecno Spark 7", 6200), ("Blackview A80", 5900),
        ("Ulefone Note 8", 5500),
    ],
    "—Ä–µ–¥–∫–∏–π": [
        ("Xiaomi Mi 11", 25000), ("Samsung A52", 24000), ("OnePlus Nord", 26000),
        ("Redmi Note 11 Pro", 27000), ("Google Pixel 5a", 25500), ("Sony Xperia 10", 23000),
        ("Xiaomi 11T", 26500), ("Samsung A72", 28000), ("Realme 8 Pro", 24500),
        ("Oppo Reno 5", 25000), ("Vivo V21", 24000), ("Honor 50", 26000),
        ("Motorola Edge 20", 27500), ("Nokia X20", 23500), ("LG Velvet", 22500),
        ("ASUS ZenFone 8", 29000), ("Poco F3", 25500), ("Infinix Zero 8", 19000),
        ("Tecno Camon 17", 17000), ("Blackview BV7100", 15000), ("Ulefone Power Armor", 18000),
        ("Doogee S88 Pro", 16500), ("Cubot KingKong", 14500), ("Oukitel WP15", 17500),
        ("AGM H5", 18500),
    ],
    "—ç–ø–∏–∫": [
        ("iPhone 12", 55000), ("Samsung S21", 58000), ("Xiaomi 12 Pro", 60000),
        ("OnePlus 10", 59000), ("Asus ROG Phone", 62000), ("iPhone 13 mini", 65000),
        ("Samsung S22", 63000), ("Xiaomi 12", 56000), ("Google Pixel 6", 57000),
        ("Sony Xperia 5 III", 61000), ("Motorola Edge 30 Pro", 58500), ("Nokia G50", 35000),
        ("LG Wing", 52000), ("ASUS ROG Phone 5", 64000), ("Poco F4 GT", 51000),
        ("Black Shark 4", 53000), ("Red Magic 6", 54500), ("ZTE Axon 30", 47000),
        ("Oppo Find X3", 59500), ("Vivo X60 Pro", 56500), ("Honor Magic 3", 60500),
        ("Realme GT", 54000), ("Meizu 18", 52500), ("Lenovo Legion Duel", 58000),
        ("Nubia Red Magic", 55000),
    ],
    "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π": [
        ("iPhone 15 Pro Max", 140000), ("Samsung S24 Ultra", 135000),
        ("–ê–Ω–¥—Ä—é—à–∫–∞ —Ñ–æ–Ω (—Ä–µ–¥–∫–∏–π –¥–æ—Ä–æ–≥–æ–π)", 200000), ("Custom Titanium Pro", 180000),
        ("Sony Xperia Pro-I", 150000), ("Google Pixel 8 Pro", 130000),
        ("iPhone 14 Pro Max", 125000), ("Samsung S23 Ultra", 120000),
        ("Xiaomi 13 Ultra", 115000), ("OnePlus 11 Pro", 110000),
        ("ASUS ROG Phone 7", 105000), ("Huawei Mate 60 Pro", 145000),
        ("Honor Magic 5 Pro", 118000), ("Oppo Find N2", 155000),
        ("Vivo X90 Pro+", 128000), ("Motorola Razr 2023", 132000),
        ("Nothing Phone 2", 95000), ("Redmi K60 Pro", 85000),
        ("Realme GT3", 89000), ("Poco F5 Pro", 82000),
        ("ZTE Axon 40 Ultra", 98000), ("Nubia Z50 Ultra", 102000),
        ("Meizu 20 Pro", 88000), ("Lenovo Legion Y90", 92000),
        ("Black Shark 5 Pro", 86000),
    ],
}

# –¶–µ–Ω—ã –Ω–∞ –ø–æ–∫—É–ø–∫—É —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
RARITY_PRICES = {
    "–æ–±—ã—á–Ω—ã–π": 800,
    "–Ω–µ–æ–±—ã—á–Ω—ã–π": 2500,
    "—Ä–µ–¥–∫–∏–π": 8000,
    "—ç–ø–∏–∫": 20000,
    "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π": 50000,
}

# –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
COND_MULT = {
    "‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ": 1.3,
    "‚úÖ –•–æ—Ä–æ—à–µ–µ": 1.0,
    "ü§î –ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ": 0.6,
    "üí© –£–±–∏—Ç–æ–µ": 0.3,
    "üÜï –ù–æ–≤–æ–µ": 1.5,
    "üì¶ –ó–∞–ø–µ—á–∞—Ç–∞–Ω–Ω–æ–µ": 1.8,
    "üîß –ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞": 0.7,
    "üíé –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ": 2.0,
}

# –í—Å–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã –¥–ª—è –∫–µ–π—Å–æ–≤ (—Ç–æ–ª—å–∫–æ –±—é–¥–∂–µ—Ç–Ω—ã–µ, –º–∞–∫—Å–∏–º—É–º 15000)
CASE_PHONES = [
    ("Nokia 3310", 1500), ("Siemens A35", 1200), ("Philips Xenium", 1800),
    ("Redmi 9A", 2000), ("–ñ–µ–∫–∞ —Ñ–æ–Ω", 500), ("Alcatel OT-101", 800),
    ("Fly IQ440", 1500), ("Xiaomi Redmi Note 10", 4000), ("Samsung A12", 3800),
    ("Realme C21", 3500), ("Motorola Moto G", 4000), ("Huawei Y6", 3900),
    ("Nokia 5.3", 4100), ("LG K11", 1700), ("ZTE Blade A5", 1400),
    ("HTC Desire 12", 1900), ("Nokia 105", 600), ("Samsung E1200", 400),
    ("Motorola C117", 300), ("Panasonic GD55", 250), ("Philips S200", 1100),
    ("Alcatel 1066", 450), ("Redmi 8A", 1900), ("Realme C11", 1800),
    ("Oppo A15", 2100), ("Vivo Y12", 2000), ("Honor 7A", 1950),
    ("Lenovo K5", 1850), ("Meizu M5", 1750), ("ASUS ZenFone Live", 1650),
    ("Micromax Bharat", 800), ("Xiaomi Redmi 9T", 3200), ("Samsung A22", 3800),
    ("Realme 7i", 3500), ("Oppo A54", 3400), ("Vivo Y20", 3300),
    ("Honor 8A", 2900), ("LG K52", 3100), ("Motorola E7", 3000),
    ("Nokia 3.4", 3200), ("Sony Xperia L4", 3600), ("ASUS ZenFone Max", 3400),
    ("Poco M3", 3700), ("Infinix Hot 10", 2800), ("Tecno Spark 7", 2600),
    ("Blackview A80", 2400), ("Ulefone Note 8", 2200),
]

PHRASES = [
    "üé∞ –§–ª–∏–ø!", "üîÑ –ö—Ä—É—Ç–∏–º!", "üé≤ –£–¥–∞—á–∞ —Å–µ–≥–æ–¥–Ω—è —Å —Ç–æ–±–æ–π!", "‚≠ê –î–∂–µ–∫–ø–æ—Ç?",
    "üí∞ –ë–æ–≥–∞—Ç—Å—Ç–≤–æ –±–ª–∏–∑–∫–æ!", "üçÄ –í–µ–∑–µ–Ω–∏–µ!", "‚ú® –ú–∞–≥–∏—è —Ñ–ª–∏–ø–∞!", "üéØ –í —è–±–ª–æ—á–∫–æ!",
    "üí´ –§–æ—Ä—Ç—É–Ω–∞ —É–ª—ã–±–∞–µ—Ç—Å—è!", "üî• –ì–æ—Ä—è—á–∏–π —Ñ–ª–∏–ø!",
]

USERS_FILE = "users.json"
lock = Lock()
_users = {}

# --- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ ---
admin_states = {}  # –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –∞–¥–º–∏–Ω–∞

# --- –°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏ (–∞—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å) ---

def load_users():
    global _users
    if os.path.exists(USERS_FILE):
        try:
            with open(USERS_FILE, "r", encoding="utf-8") as f:
                _users = json.load(f)
            logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –±–∞–∑—ã: {e}")
            _users = {}
    else:
        _users = {}
        save_users()


def save_users():
    with lock:
        try:
            dirn = os.path.dirname(os.path.abspath(USERS_FILE)) or "."
            fd, tmp_path = tempfile.mkstemp(dir=dirn)
            with os.fdopen(fd, "w", encoding="utf-8") as f:
                json.dump(_users, f, ensure_ascii=False, indent=2)
            os.replace(tmp_path, USERS_FILE)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–∑—ã: {e}")


def get_user(m):
    uid = str(m.from_user.id)
    if uid not in _users:
        _users[uid] = {
            "name": m.from_user.first_name or "–ü–µ—Ä–µ–∫—É–ø",
            "balance": 5000,
            "inventory": [],
            "last_flip": 0,
            "exp": 0,
            "lvl": 1,
        }
        save_users()
    return _users[uid]


def get_user_by_id(user_id):
    """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID"""
    uid = str(user_id)
    return _users.get(uid)


# --- –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –ê–î–ú–ò–ù–ê ---

def is_admin(user_id, username=None):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º (MATERbBOGOV1)"""
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ ID
    if user_id == ADMIN_ID:
        return True
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É
    if username and username.lower() == ADMIN_USERNAME.lower():
        return True
    
    return False


# --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø/–ó–ê–ì–†–£–ó–ö–ò –ü–†–û–ì–†–ï–°–°–ê ---

def export_user_data(user_id):
    """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å—Ç—Ä–æ–∫—É JSON"""
    if str(user_id) in _users:
        data = _users[str(user_id)].copy()
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        data['_export_version'] = '1.0'
        data['_export_date'] = time.time()
        return json.dumps(data, ensure_ascii=False, indent=2)
    return None


def import_user_data(user_id, json_data):
    """–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å—Ç—Ä–æ–∫–∏ JSON"""
    try:
        new_data = json.loads(json_data)
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        required_fields = ['name', 'balance', 'inventory', 'last_flip', 'exp', 'lvl']
        for field in required_fields:
            if field not in new_data:
                return False, f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ {field}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
        for item in new_data.get('inventory', []):
            if not all(k in item for k in ['name', 'price', 'cond']):
                return False, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è"
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        _users[str(user_id)] = new_data
        save_users()
        return True, "–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!"
    except json.JSONDecodeError:
        return False, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON"
    except Exception as e:
        return False, f"–û—à–∏–±–∫–∞: {str(e)}"


# --- –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ (–¢–û–õ–¨–ö–û –î–õ–Ø @MATERbBOGOV1) ---

@bot.message_handler(commands=["adminpanel"])
def admin_panel(m):
    """–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–∞–º–∏"""
    user_id = m.from_user.id
    username = m.from_user.username
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∞–¥–º–∏–Ω
    if not is_admin(user_id, username):
        return bot.send_message(m.chat.id, "‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è @MATERbBOGOV1!")
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    markup = types.InlineKeyboardMarkup(row_width=2)
    
    btn1 = types.InlineKeyboardButton("üìÅ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å", callback_data="admin_save")
    btn2 = types.InlineKeyboardButton("üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å", callback_data="admin_load")
    btn3 = types.InlineKeyboardButton("‚è±Ô∏è –°–±—Ä–æ—Å–∏—Ç—å –ö–î –∏–≥—Ä–æ–∫—É", callback_data="admin_reset_cd")
    btn4 = types.InlineKeyboardButton("üí∞ –í—ã–¥–∞—Ç—å –¥–µ–Ω—å–≥–∏", callback_data="admin_add_money")
    btn5 = types.InlineKeyboardButton("üì± –í—ã–¥–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω", callback_data="admin_add_phone")
    btn6 = types.InlineKeyboardButton("üîç –ò–Ω—Ñ–æ –æ –∏–≥—Ä–æ–∫–µ", callback_data="admin_player_info")
    btn7 = types.InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞", callback_data="admin_stats")
    btn8 = types.InlineKeyboardButton("üíæ –ë–µ–∫–∞–ø –±–∞–∑—ã", callback_data="admin_backup")
    
    markup.add(btn1, btn2, btn3, btn4, btn5, btn6, btn7, btn8)
    
    bot.send_message(
        m.chat.id,
        "üëë *–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ @MATERbBOGOV1*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=markup,
        parse_mode="Markdown"
    )


@bot.callback_query_handler(func=lambda call: call.data.startswith("admin_"))
def admin_callback(call):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"""
    user_id = call.from_user.id
    username = call.from_user.username
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∞–¥–º–∏–Ω
    if not is_admin(user_id, username):
        bot.answer_callback_query(call.id, "‚ùå –¢–æ–ª—å–∫–æ –¥–ª—è @MATERbBOGOV1!", show_alert=True)
        return
    
    action = call.data
    
    if action == "admin_save":
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
        bot.answer_callback_query(call.id)
        save_progress_command(call.message)
    
    elif action == "admin_load":
        # –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
        bot.answer_callback_query(call.id)
        load_progress_command(call.message)
    
    elif action == "admin_reset_cd":
        # –°–±—Ä–æ—Å–∏—Ç—å –ö–î
        bot.answer_callback_query(call.id)
        msg = bot.send_message(
            call.message.chat.id,
            "‚è±Ô∏è –í–≤–µ–¥–∏ **ID –∏–ª–∏ @username** –∏–≥—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –ö–î —Ñ–ª–∏–ø–∞:\n\n"
            "(–º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å —á–µ—Ä–µ–∑ `–ò–Ω—Ñ–æ –æ –∏–≥—Ä–æ–∫–µ`)"
        )
        admin_states[user_id] = {"action": "reset_cd"}
        bot.register_next_step_handler(msg, process_admin_reset_cd)
    
    elif action == "admin_add_money":
        # –í—ã–¥–∞—Ç—å –¥–µ–Ω—å–≥–∏
        bot.answer_callback_query(call.id)
        msg = bot.send_message(
            call.message.chat.id,
            "üí∞ –í–≤–µ–¥–∏ **ID –∏–ª–∏ @username** –∏–≥—Ä–æ–∫–∞ –∏ —Å—É–º–º—É —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª\n"
            "–ü—Ä–∏–º–µ—Ä: `@username 10000` –∏–ª–∏ `123456789 5000`"
        )
        admin_states[user_id] = {"action": "add_money"}
        bot.register_next_step_handler(msg, process_admin_add_money)
    
    elif action == "admin_add_phone":
        # –í—ã–¥–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
        bot.answer_callback_query(call.id)
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —Ä–µ–¥–∫–æ—Å—Ç—è–º–∏
        markup = types.InlineKeyboardMarkup(row_width=2)
        for rarity in PHONES_POOLS.keys():
            btn = types.InlineKeyboardButton(rarity.title(), callback_data=f"addphone_rarity_{rarity}")
            markup.add(btn)
        
        bot.send_message(
            call.message.chat.id,
            "üì± –í—ã–±–µ—Ä–∏ —Ä–µ–¥–∫–æ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –≤—ã–¥–∞—á–∏:",
            reply_markup=markup
        )
    
    elif action == "admin_player_info":
        # –ò–Ω—Ñ–æ –æ –∏–≥—Ä–æ–∫–µ
        bot.answer_callback_query(call.id)
        msg = bot.send_message(
            call.message.chat.id,
            "üîç –í–≤–µ–¥–∏ **ID** –∏–ª–∏ **@username** –∏–≥—Ä–æ–∫–∞:"
        )
        admin_states[user_id] = {"action": "player_info"}
        bot.register_next_step_handler(msg, process_admin_player_info)
    
    elif action == "admin_stats":
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞
        bot.answer_callback_query(call.id)
        show_bot_stats(call.message)
    
    elif action == "admin_backup":
        # –ë–µ–∫–∞–ø –±–∞–∑—ã
        bot.answer_callback_query(call.id)
        create_backup(call.message)


@bot.callback_query_handler(func=lambda call: call.data.startswith("addphone_rarity_"))
def add_phone_rarity_callback(call):
    """–í—ã–±–æ—Ä —Ä–µ–¥–∫–æ—Å—Ç–∏ –¥–ª—è –≤—ã–¥–∞—á–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
    user_id = call.from_user.id
    
    if not is_admin(user_id, call.from_user.username):
        bot.answer_callback_query(call.id, "‚ùå –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞!", show_alert=True)
        return
    
    rarity = call.data.replace("addphone_rarity_", "")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ä–µ–¥–∫–æ—Å—Ç—å
    admin_states[user_id] = {"action": "add_phone", "rarity": rarity}
    
    msg = bot.send_message(
        call.message.chat.id,
        f"üì± –í—ã–±—Ä–∞–Ω–∞ —Ä–µ–¥–∫–æ—Å—Ç—å: *{rarity.title()}*\n\n"
        "–í–≤–µ–¥–∏ **ID –∏–ª–∏ @username** –∏–≥—Ä–æ–∫–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª\n"
        "–°–æ—Å—Ç–æ—è–Ω–∏—è: `–ù–æ–≤–æ–µ`, `–ò–¥–µ–∞–ª—å–Ω–æ–µ`, `–•–æ—Ä–æ—à–µ–µ`, `–ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ`, `–£–±–∏—Ç–æ–µ`, `–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ`\n\n"
        "–ü—Ä–∏–º–µ—Ä: `@username –ò–¥–µ–∞–ª—å–Ω–æ–µ` –∏–ª–∏ `123456789 –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ`"
    )
    
    bot.register_next_step_handler(msg, process_admin_add_phone)


# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ê–î–ú–ò–ù-–ö–û–ú–ê–ù–î ---

def process_admin_reset_cd(m):
    """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ö–î –∏–≥—Ä–æ–∫—É"""
    user_id = m.from_user.id
    input_text = m.text.strip()
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª—å (ID –∏–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º)
    target_id = None
    
    if input_text.startswith('@'):
        # –ü–æ–∏—Å–∫ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É
        username = input_text[1:].lower()
        for uid, data in _users.items():
            if data.get('username', '').lower() == username:
                target_id = uid
                break
    else:
        # –ü–æ ID
        try:
            if input_text.isdigit():
                target_id = input_text
        except:
            pass
    
    if not target_id or target_id not in _users:
        return bot.send_message(m.chat.id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ö–î
    _users[target_id]['last_flip'] = 0
    save_users()
    
    player_name = _users[target_id]['name']
    bot.send_message(
        m.chat.id,
        f"‚úÖ –ö–î —Ñ–ª–∏–ø–∞ –¥–ª—è *{player_name}* —Å–±—Ä–æ—à–µ–Ω!\n"
        f"–¢–µ–ø–µ—Ä—å –æ–Ω –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `–∫–∞—Ä—Ç`"
    )


def process_admin_add_money(m):
    """–í—ã–¥–∞–µ—Ç –¥–µ–Ω—å–≥–∏ –∏–≥—Ä–æ–∫—É"""
    user_id = m.from_user.id
    input_text = m.text.strip()
    parts = input_text.split()
    
    if len(parts) != 2:
        return bot.send_message(m.chat.id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –ù—É–∂–Ω–æ: `@username —Å—É–º–º–∞` –∏–ª–∏ `ID —Å—É–º–º–∞`")
    
    target_input, amount_str = parts
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª—å
    target_id = None
    
    if target_input.startswith('@'):
        username = target_input[1:].lower()
        for uid, data in _users.items():
            if data.get('username', '').lower() == username:
                target_id = uid
                break
    else:
        if target_input.isdigit():
            target_id = target_input
    
    if not target_id or target_id not in _users:
        return bot.send_message(m.chat.id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    
    try:
        amount = int(amount_str)
        if amount <= 0:
            raise ValueError
    except:
        return bot.send_message(m.chat.id, "‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º!")
    
    # –í—ã–¥–∞–µ–º –¥–µ–Ω—å–≥–∏
    _users[target_id]['balance'] += amount
    save_users()
    
    player_name = _users[target_id]['name']
    bot.send_message(
        m.chat.id,
        f"‚úÖ –ò–≥—Ä–æ–∫—É *{player_name}* –≤—ã–¥–∞–Ω–æ *{amount:,}$*\n"
        f"–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: *{_users[target_id]['balance']:,}$*"
    )


def process_admin_add_phone(m):
    """–í—ã–¥–∞–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω –∏–≥—Ä–æ–∫—É"""
    user_id = m.from_user.id
    input_text = m.text.strip()
    parts = input_text.split(maxsplit=1)
    
    if len(parts) != 2:
        return bot.send_message(m.chat.id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –ù—É–∂–Ω–æ: `@username —Å–æ—Å—Ç–æ—è–Ω–∏–µ`")
    
    target_input, condition_input = parts
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    condition_map = {
        "–Ω–æ–≤–æ–µ": "üÜï –ù–æ–≤–æ–µ",
        "–∏–¥–µ–∞–ª—å–Ω–æ–µ": "‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ",
        "—Ö–æ—Ä–æ—à–µ–µ": "‚úÖ –•–æ—Ä–æ—à–µ–µ",
        "–ø–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ": "ü§î –ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ",
        "—É–±–∏—Ç–æ–µ": "üí© –£–±–∏—Ç–æ–µ",
        "–∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ": "üíé –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ",
        "–∑–∞–ø–µ—á–∞—Ç–∞–Ω–Ω–æ–µ": "üì¶ –ó–∞–ø–µ—á–∞—Ç–∞–Ω–Ω–æ–µ",
    }
    
    condition_lower = condition_input.lower()
    if condition_lower not in condition_map:
        return bot.send_message(
            m.chat.id,
            "‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ! –î–æ—Å—Ç—É–ø–Ω—ã: –ù–æ–≤–æ–µ, –ò–¥–µ–∞–ª—å–Ω–æ–µ, –•–æ—Ä–æ—à–µ–µ, –ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ, –£–±–∏—Ç–æ–µ, –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ, –ó–∞–ø–µ—á–∞—Ç–∞–Ω–Ω–æ–µ"
        )
    
    condition = condition_map[condition_lower]
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª—å
    target_id = None
    
    if target_input.startswith('@'):
        username = target_input[1:].lower()
        for uid, data in _users.items():
            if data.get('username', '').lower() == username:
                target_id = uid
                break
    else:
        if target_input.isdigit():
            target_id = target_input
    
    if not target_id or target_id not in _users:
        return bot.send_message(m.chat.id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    
    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    rarity = admin_states.get(user_id, {}).get('rarity', '–æ–±—ã—á–Ω—ã–π')
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ –ø—É–ª–∞
    pool = PHONES_POOLS[rarity]
    base_name, base_price = random.choice(pool)
    
    mult = COND_MULT.get(condition, 1.0)
    final_price = int(base_price * mult)
    
    # –í—ã–¥–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
    _users[target_id]['inventory'].append({
        "name": base_name,
        "price": final_price,
        "cond": condition
    })
    save_users()
    
    player_name = _users[target_id]['name']
    bot.send_message(
        m.chat.id,
        f"‚úÖ –ò–≥—Ä–æ–∫—É *{player_name}* –≤—ã–¥–∞–Ω —Ç–µ–ª–µ—Ñ–æ–Ω:\n"
        f"üì± *{base_name}*\n"
        f"üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: {condition}\n"
        f"üí∞ –¶–µ–Ω–∞: *{final_price:,}$*"
    )
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if user_id in admin_states:
        del admin_states[user_id]


def process_admin_player_info(m):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∏–≥—Ä–æ–∫–µ"""
    user_id = m.from_user.id
    input_text = m.text.strip()
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª—å
    target_id = None
    
    if input_text.startswith('@'):
        username = input_text[1:].lower()
        for uid, data in _users.items():
            if data.get('username', '').lower() == username:
                target_id = uid
                break
    else:
        if input_text.isdigit():
            target_id = input_text
    
    if not target_id or target_id not in _users:
        return bot.send_message(m.chat.id, "‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!")

    player = _users[target_id]
    
    # –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ–ª–∏–ø–∞
    current_time = int(time.time())
    time_passed = current_time - player.get('last_flip', 0)
    
    if time_passed >= FLIP_COOLDOWN:
        flip_status = "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω"
    else:
        remaining = FLIP_COOLDOWN - time_passed
        hours = remaining // 3600
        minutes = (remaining % 3600) // 60
        flip_status = f"‚è≥ –ß–µ—Ä–µ–∑ {hours}—á {minutes}–º"
    
    # –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    inv_value = sum(item['price'] for item in player.get('inventory', []))
    
    # –¢–æ–ø 5 —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
    top_phones = sorted(player.get('inventory', []), key=lambda x: x['price'], reverse=True)[:5]
    phones_text = ""
    if top_phones:
        for i, phone in enumerate(top_phones, 1):
            phones_text += f"{i}. {phone['name']} ({phone['cond']}) ‚Äî *{phone['price']:,}$*\n"
    else:
        phones_text = "–ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤"
    
    msg = (
        f"üë§ *–ò–ù–§–û –û –ò–ì–†–û–ö–ï*\n\n"
        f"üÜî ID: `{target_id}`\n"
        f"üìõ –ò–º—è: {player['name']}\n"
        f"üè∑Ô∏è Username: @{player.get('username', '–Ω–µ—Ç')}\n\n"
        f"üí∞ –ë–∞–ª–∞–Ω—Å: *{player['balance']:,}$*\n"
        f"üì± –¢–µ–ª–µ—Ñ–æ–Ω–æ–≤: {len(player.get('inventory', []))} (üíé {inv_value:,}$)\n"
        f"‚≠ê –£—Ä–æ–≤–µ–Ω—å: {player['lvl']} ({player['exp']} XP)\n"
        f"üé∞ –§–ª–∏–ø: {flip_status}\n\n"
        f"üèÜ *–¢–æ–ø —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤:*\n{phones_text}"
    )
    
    bot.send_message(m.chat.id, msg)
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if user_id in admin_states:
        del admin_states[user_id]


def show_bot_stats(m):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–æ—Ç–∞"""
    total_players = len(_users)
    total_balance = sum(u['balance'] for u in _users.values())
    total_phones = sum(len(u.get('inventory', [])) for u in _users.values())
    
    # –¢–æ–ø 5 –±–æ–≥–∞—Ç—ã—Ö
    top_players = sorted(_users.values(), key=lambda x: x['balance'], reverse=True)[:5]
    top_text = ""
    for i, p in enumerate(top_players, 1):
        top_text += f"{i}. {p['name']} ‚Äî *{p['balance']:,}$* (üì± {len(p.get('inventory', []))})\n"
    
    msg = (
        f"üìä *–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–û–¢–ê*\n\n"
        f"üë• –í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤: *{total_players}*\n"
        f"üí∞ –û–±—â–∏–π –±–∞–ª–∞–Ω—Å: *{total_balance:,}$*\n"
        f"üì± –í—Å–µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤: *{total_phones}*\n\n"
        f"üèÜ *–¢–æ–ø 5 –±–æ–≥–∞—Ç—ã—Ö:*\n{top_text}"
    )
    
    bot.send_message(m.chat.id, msg)


def create_backup(m):
    """–°–æ–∑–¥–∞–µ—Ç –±–µ–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    filename = f"backup_{int(time.time())}.json"
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(_users, f, ensure_ascii=False, indent=2)
    
    with open(filename, 'rb') as f:
        bot.send_document(m.chat.id, f, caption="üíæ –ë–µ–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
    
    os.remove(filename)


def save_progress_command(m):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º"""
    user_id = m.from_user.id
    json_data = export_user_data(user_id)
    if not json_data:
        return bot.send_message(m.chat.id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ")
    
    filename = f"save_{user_id}_{int(time.time())}.txt"
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(json_data)
    
    with open(filename, 'rb') as f:
        bot.send_document(m.chat.id, f, caption="üìÅ –¢–≤–æ—ë —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–≥—Ä—ã")
    
    os.remove(filename)


def load_progress_command(m):
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏"""
    msg = bot.send_message(m.chat.id, 
        "üì§ –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–∞–π–ª .txt —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º\n\n"
        "‚ö†Ô∏è *–í–Ω–∏–º–∞–Ω–∏–µ!* –≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–∏—Ç —Ç–≤–æ–π —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å!")
    bot.register_next_step_handler(msg, process_load_file)


def process_load_file(m):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª"""
    if not m.document:
        return bot.send_message(m.chat.id, "‚ùå –≠—Ç–æ –Ω–µ —Ñ–∞–π–ª. –û—Ç–ø—Ä–∞–≤—å .txt —Ñ–∞–π–ª")
    
    if not m.document.file_name.endswith('.txt'):
        return bot.send_message(m.chat.id, "‚ùå –ù—É–∂–µ–Ω .txt —Ñ–∞–π–ª")
    
    try:
        file_info = bot.get_file(m.document.file_id)
        downloaded_file = bot.download_file(file_info.file_path)
        json_data = downloaded_file.decode('utf-8')
        
        success, message = import_user_data(m.from_user.id, json_data)
        
        if success:
            user = get_user(m)
            bot.send_message(m.chat.id, 
                f"‚úÖ *–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω!*\n\n"
                f"üë§ –ò–≥—Ä–æ–∫: {user['name']}\n"
                f"üí∞ –ë–∞–ª–∞–Ω—Å: {user['balance']:,}$\n"
                f"üì± –¢–µ–ª–µ—Ñ–æ–Ω–æ–≤: {len(user['inventory'])}\n"
                f"‚≠ê –£—Ä–æ–≤–µ–Ω—å: {user['lvl']}")
        else:
            bot.send_message(m.chat.id, f"‚ùå –û—à–∏–±–∫–∞: {message}")
            
    except Exception as e:
        bot.send_message(m.chat.id, f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")


# --- –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ ---

def add_exp(user, amount):
    user["exp"] += amount
    next_lvl = user["lvl"] * 150
    if user["exp"] >= next_lvl:
        user["lvl"] += 1
        user["exp"] = 0
        return True
    return False


def can_flip(user):
    current_time = int(time.time())
    time_passed = current_time - user.get("last_flip", 0)
    if time_passed >= FLIP_COOLDOWN:
        return True, 0
    else:
        remaining = FLIP_COOLDOWN - time_passed
        hours = remaining // 3600
        minutes = (remaining % 3600) // 60
        return False, f"{hours}—á {minutes}–º"


# --- –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ ---

@bot.message_handler(commands=["start", "help"])
def start_cmd(m):
    if m.from_user.username:
        uid = str(m.from_user.id)
        if uid in _users:
            _users[uid]['username'] = m.from_user.username
            save_users()
    
    is_admin_user = is_admin(m.from_user.id, m.from_user.username)
    admin_text = ""
    if is_admin_user:
        admin_text = "\nüëë *–ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨:* `/adminpanel`\n"
    
    msg = (
        "üì± *–î–û–ë–†–û –ü–û–ñ–ê–õ–û–í–ê–¢–¨ –í –°–ò–ú–£–õ–Ø–¢–û–† –ü–ï–†–ï–ö–£–ü–ê!*"
        f"{admin_text}\n"
        "üé∞ *–§–õ–ò–ü:*\n"
        "‚Ä¢ `–∫–∞—Ä—Ç` –∏–ª–∏ `—Ñ–ª–∏–ø` ‚Äî –∫—Ä—É—Ç–∏—Ç—å —Ñ–ª–∏–ø —Ä–∞–∑ –≤ 3 —á–∞—Å–∞!\n\n"
        "üõí *–ú–∞–≥–∞–∑–∏–Ω:*\n"
        "‚Ä¢ `–º–∞–≥–∞–∑–∏–Ω` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω\n"
        "‚Ä¢ `–∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω [—Ä–µ–¥–∫–æ—Å—Ç—å]` ‚Äî –∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω\n"
        "‚Ä¢ `–∫—É–ø–∏—Ç—å –∫–µ–π—Å` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å (5,000$)\n"
        "‚Ä¢ `—Ç–ª` ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—ã\n"
        "‚Ä¢ `–ø—Ä–æ–¥–∞—Ç—å [–Ω–æ–º–µ—Ä]` ‚Äî –ø—Ä–æ–¥–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω\n\n"
        "üìä *–ü—Ä–æ—á–µ–µ:*\n"
        "‚Ä¢ `–ø—Ä–æ—Ñ–∏–ª—å` ‚Äî —Ç–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
        "‚Ä¢ `—Ç–æ–ø` ‚Äî —Å–ø–∏—Å–æ–∫ –ª—É—á—à–∏—Ö\n\n"
        "üéÆ *–í—Å–µ–≥–æ –±–æ–ª–µ–µ 50 –º–æ–¥–µ–ª–µ–π —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤!*"
    )
    bot.send_message(m.chat.id, msg)


@bot.message_handler(func=lambda m: m.text and m.text.lower() == "–º–∞–≥–∞–∑–∏–Ω")
def open_shop(m):
    msg = "üõí *–ú–ê–ì–ê–ó–ò–ù*\n\n"
    msg += "‚Ä¢ `–∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω [—Ä–µ–¥–∫–æ—Å—Ç—å]` ‚Äî —Ä–µ–¥–∫–æ—Å—Ç–∏: –æ–±—ã—á–Ω—ã–π, –Ω–µ–æ–±—ã—á–Ω—ã–π, —Ä–µ–¥–∫–∏–π, —ç–ø–∏–∫, –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π\n"
    msg += "‚Ä¢ `–∫—É–ø–∏—Ç—å –∫–µ–π—Å` ‚Äî *5,000$*\n\n"
    msg += "–¶–µ–Ω—ã:\n"
    for r, p in RARITY_PRICES.items():
        msg += f"‚Ä¢ *{r.title()}* ‚Äî *{p:,}$*\n"
    bot.send_message(m.chat.id, msg)


@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith("–∫—É–ø–∏—Ç—å –∫–µ–π—Å") or m.text.lower() == "–∫—É–ø–∏—Ç—å 1")
def buy_case(m):
    user = get_user(m)
    cost = 5000
    if user["balance"] < cost:
        return bot.send_message(m.chat.id, "‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥!")
    
    p_name, p_price = random.choice(CASE_PHONES)
    condition = random.choice(["üÜï –ù–æ–≤–æ–µ", "‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ", "‚úÖ –•–æ—Ä–æ—à–µ–µ", "ü§î –ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ", "üí© –£–±–∏—Ç–æ–µ"])
    mult = COND_MULT.get(condition, 1.0)
    final_price = int(p_price * mult)
    
    if final_price > 15000:
        final_price = 15000
    
    user["balance"] -= cost
    user["inventory"].append({"name": p_name, "price": final_price, "cond": condition})
    save_users()
    
    bot.send_message(m.chat.id, f"üéÅ –ò–∑ –∫–µ–π—Å–∞ –≤—ã–ø–∞–ª: *{p_name}*\n{condition}\nüí∞ *{final_price:,}$*")


@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith("–∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω"))
def buy_phone(m):
    user = get_user(m)
    parts = m.text.lower().split()
    if len(parts) < 3:
        return bot.send_message(m.chat.id, "‚ùå –ù–∞–ø–∏—à–∏: `–∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω [—Ä–µ–¥–∫–æ—Å—Ç—å]`")
    
    rarity = parts[-1]
    if rarity not in RARITY_PRICES:
        return bot.send_message(m.chat.id, "‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Ä–µ–¥–∫–æ—Å—Ç—å!")
    
    cost = RARITY_PRICES[rarity]
    if user["balance"] < cost:
        return bot.send_message(m.chat.id, f"‚ùå –ù—É–∂–Ω–æ {cost:,}$")
    
    pool = PHONES_POOLS.get(rarity, [])
    if not pool:
        return bot.send_message(m.chat.id, "‚ùå –û—à–∏–±–∫–∞!")
    
    base_name, base_price = random.choice(pool)
    conditions = ["üÜï –ù–æ–≤–æ–µ", "‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ", "‚úÖ –•–æ—Ä–æ—à–µ–µ", "ü§î –ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ", "üíé –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ"]
    weights = [5, 15, 40, 25, 2]
    condition = random.choices(conditions, weights=weights)[0]
    
    mult = COND_MULT.get(condition, 1.0)
    final_price = int(base_price * mult)
    user["balance"] -= cost
    user["inventory"].append({"name": base_name, "price": final_price, "cond": condition})
    add_exp(user, 10)
    save_users()
    
    bot.send_message(m.chat.id, f"üõçÔ∏è –¢—ã –∫—É–ø–∏–ª: *{base_name}*\n{condition}\nüí∞ *{final_price:,}$*")


@bot.message_handler(func=lambda m: m.text and m.text.lower() in ["–∫–∞—Ä—Ç", "—Ñ–ª–∏–ø"])
def flip_feature(m):
    user = get_user(m)
    
    can, remaining = can_flip(user)
    if not can:
        return bot.send_message(m.chat.id, f"‚è≥ –§–ª–∏–ø —á–µ—Ä–µ–∑: *{remaining}*")
    
    rarities = ["–æ–±—ã—á–Ω—ã–π", "–Ω–µ–æ–±—ã—á–Ω—ã–π", "—Ä–µ–¥–∫–∏–π", "—ç–ø–∏–∫", "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π"]
    weights = [50, 25, 15, 7, 3]
    chosen_rarity = random.choices(rarities, weights=weights)[0]
    
    pool = PHONES_POOLS[chosen_rarity]
    base_name, base_price = random.choice(pool)
    
    conditions = ["üÜï –ù–æ–≤–æ–µ", "‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ", "‚úÖ –•–æ—Ä–æ—à–µ–µ", "ü§î –ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω–æ–µ", "üí© –£–±–∏—Ç–æ–µ", "üì¶ –ó–∞–ø–µ—á–∞—Ç–∞–Ω–Ω–æ–µ", "üíé –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω–æ–µ"]
    weights = [8, 15, 35, 25, 5, 3, 2]
    condition = random.choices(conditions, weights=weights)[0]
    
    mult = COND_MULT.get(condition, 1.0)
    final_price = int(base_price * mult)
    
    user["inventory"].append({"name": base_name, "price": final_price, "cond": condition})
    user["last_flip"] = int(time.time())
    lvl_up = add_exp(user, 30)
    save_users()
    
    phrase = random.choice(PHRASES)
    msg = f"{phrase}\n\nüì± *{base_name}*\nüè∑Ô∏è {chosen_rarity.title()}\nüìä {condition}\nüí∞ *{final_price:,}$*\n\n‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å"
    
    if lvl_up:
        msg += "\n\nüèÜ *–£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù!*"
    
    if random.random() < 0.02 and chosen_rarity != "–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π":
        time.sleep(1)
        second_rarity = random.choices(rarities, weights=weights)[0]
        second_pool = PHONES_POOLS[second_rarity]
        second_name, second_price = random.choice(second_pool)
        second_condition = random.choices(conditions, weights=weights)[0]
        second_mult = COND_MULT.get(second_condition, 1.0)
        second_final = int(second_price * second_mult)
        
        user["inventory"].append({"name": second_name, "price": second_final, "cond": second_condition})
        save_users()
        msg += f"\n\nüéä *–î–í–û–ô–ù–û–ô –§–õ–ò–ü!*\nüì± +{second_name} ({second_condition}) ‚Äî *{second_final:,}$*"
    
    bot.send_message(m.chat.id, msg)


@bot.message_handler(func=lambda m: m.text and m.text.lower() == "—Ç–ª")
def my_inventory(m):
    user = get_user(m)
    inv = user.get("inventory", [])
    if not inv:
        return bot.send_message(m.chat.id, "üì± –£ —Ç–µ–±—è –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤")
    
    sorted_inv = sorted(inv, key=lambda x: x['price'], reverse=True)
    msg = f"üì± *–°–∫–ª–∞–¥ (LVL {user['lvl']}):*\n\n"
    total_value = sum(item['price'] for item in inv)
    
    for i, item in enumerate(sorted_inv, 1):
        msg += f"{i}. {item['name']} ({item['cond']}) ‚Äî *{item['price']:,}$*\n"
    
    msg += f"\nüí∞ *–í—Å–µ–≥–æ:* {total_value:,}$\n\n`–ø—Ä–æ–¥–∞—Ç—å [–Ω–æ–º–µ—Ä]`"
    bot.send_message(m.chat.id, msg)


@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith("–ø—Ä–æ–¥–∞—Ç—å "))
def sell_phone(m):
    user = get_user(m)
    try:
        idx = int(m.text.split()[-1]) - 1
        if idx < 0 or idx >= len(user["inventory"]):
            raise ValueError
        
        sorted_inv = sorted(user["inventory"], key=lambda x: x['price'], reverse=True)
        item = sorted_inv[idx]
        
        for i, inv_item in enumerate(user["inventory"]):
            if inv_item['name'] == item['name'] and inv_item['price'] == item['price']:
                user["inventory"].pop(i)
                break
        
        user["balance"] += item['price']
        lvl_up = add_exp(user, 20)
        save_users()
        
        msg = f"ü§ù –¢—ã –ø—Ä–æ–¥–∞–ª {item['name']} –∑–∞ *{item['price']:,}$*"
        if lvl_up:
            msg += "\n\nüèÜ *–£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù!*"
        
        bot.send_message(m.chat.id, msg)
    except:
        bot.send_message(m.chat.id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä")


@bot.message_handler(func=lambda m: m.text and m.text.lower() == "–ø—Ä–æ—Ñ–∏–ª—å")
def profile(m):
    user = get_user(m)
    can, remaining = can_flip(user)
    flip_status = "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω" if can else f"‚è≥ –ß–µ—Ä–µ–∑: {remaining}"
    total_value = sum(item['price'] for item in user['inventory'])
    
    msg = (
        f"üë§ *–ò–≥—Ä–æ–∫:* {user['name']}\n"
        f"üí∞ *–ë–∞–ª–∞–Ω—Å:* {user['balance']:,}$\n"
        f"üì¶ *–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å:* {len(user['inventory'])} —à—Ç. (üíé {total_value:,}$)\n"
        f"‚≠ê *–£—Ä–æ–≤–µ–Ω—å:* {user['lvl']} ({user['exp']} XP)\n"
        f"üé∞ *–§–ª–∏–ø:* {flip_status}"
    )
    bot.send_message(m.chat.id, msg)


@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith("—Å—Ç–∞–≤–∫–∞ "))
def casino(m):
    user = get_user(m)
    try:
        amount = int(m.text.split()[-1])
        if amount <= 0 or amount > user["balance"]:
            return bot.send_message(m.chat.id, "‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞!")
        
        user["balance"] -= amount
        if random.random() < 0.4:
            win = amount * 2
            user["balance"] += win
            bot.send_message(m.chat.id, f"üìà –¢—ã –≤—ã–∏–≥—Ä–∞–ª *{win:,}$*")
        else:
            bot.send_message(m.chat.id, f"üìâ –¢—ã –ø–æ—Ç–µ—Ä—è–ª *{amount:,}$*")
        save_users()
    except:
        bot.send_message(m.chat.id, "‚ùå –ü–∏—à–∏: `—Å—Ç–∞–≤–∫–∞ 5000`")


@bot.message_handler(func=lambda m: m.text and m.text.lower() == "—Ç–æ–ø")
def top_players(m):
    top = sorted(_users.values(), key=lambda x: x['balance'], reverse=True)[:10]
    res = "üèÖ *–¢–û–ü 10 –ë–û–ì–ê–¢–´–• –ü–ï–†–ï–ö–£–ü–û–í:*\n\n"
    for i, u in enumerate(top, 1):
        inv_value = sum(item['price'] for item in u.get('inventory', []))
        res += f"{i}. {u['name']} ‚Äî *{u['balance']:,}$* (üíé {inv_value:,}$) LVL {u['lvl']}\n"
    bot.send_message(m.chat.id, res)


# --- –ó–∞–ø—É—Å–∫ ---
if __name__ == "__main__":
    load_users()
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–∂–∞–º! (50+ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤)")
    logger.info(f"–ê–¥–º–∏–Ω: @{ADMIN_USERNAME} (ID: {ADMIN_ID})")
    while True:
        try:
            bot.infinity_polling(skip_pending=True)
        except Exception as e:
            logger.exception(f"Polling —É–ø–∞–ª ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 15 —Å–µ–∫. –û—à–∏–±–∫–∞: {e}")
            time.sleep(15)
