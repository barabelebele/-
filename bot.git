import os
import time
import random
import json
import logging
from threading import Lock
import telebot

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
TOKEN = "8109307891:AAHSqQtacU_Ar_1srMJisLqD1eEPEP" # –¢–≤–æ–π —Ç–æ–∫–µ–Ω
bot = telebot.TeleBot(TOKEN)

# –î–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
REAL_PHONES = [
    ("iPhone 12", 60000),
    ("Samsung Galaxy S21", 55000),
    ("Xiaomi Mi 11", 40000),
    ("Google Pixel 5", 38000),
    ("iPhone 13 Pro", 90000),
]

CONDITIONS = {
    "‚úÖ –ë/–£ –•–æ—Ä–æ—à–µ–µ": 0.7,
    "‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ": 1.0,
    "üõ† –¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞": 0.4
}

USERS_FILE = "users.json"
lock = Lock()
_users = {}

# --- –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ ---
def load_users():
    global _users
    if os.path.exists(USERS_FILE):
        try:
            with open(USERS_FILE, "r", encoding="utf-8") as f:
                _users = json.load(f)
        except: _users = {}

def save_users():
    with open(USERS_FILE, "w", encoding="utf-8") as f:
        json.dump(_users, f, ensure_ascii=False, indent=2)

def get_user(m):
    uid = str(m.from_user.id)
    with lock:
        if uid not in _users:
            _users[uid] = {
                "name": m.from_user.first_name or "–ü–µ—Ä–µ–∫—É–ø",
                "balance": 20000,
                "inventory": [],
                "last_flip": 0
            }
            save_users()
        return _users[uid]

load_users()

# --- –ö–æ–º–∞–Ω–¥—ã ---

@bot.message_handler(commands=['start', 'help'])
def send_welcome(m):
    welcome_text = (
        "üì± **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –°–∏–º—É–ª—è—Ç–æ—Ä –ü–µ—Ä–µ–∫—É–ø–∞!**\n\n"
        "–¢–≤–æ–∏ –∫–æ–º–∞–Ω–¥—ã:\n"
        "üí∞ `–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å` ‚Äî –ø–æ–π—Ç–∏ –Ω–∞ –ø–æ–¥—Ä–∞–±–æ—Ç–∫—É\n"
        "üÉè `–ö–∞—Ä—Ç` ‚Äî –∫—É–ø–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∑–∞ 10,000$\n"
        "üì¶ `–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å` ‚Äî —Å–ø–∏—Å–æ–∫ —Ç–≤–æ–∏—Ö –¥–µ–≤–∞–π—Å–æ–≤\n"
        "üë§ `–ü—Ä–æ—Ñ–∏–ª—å` ‚Äî —Ç–≤–æ–π –±–∞–ª–∞–Ω—Å\n"
        "ü§ù `–ü—Ä–æ–¥–∞—Ç—å [–Ω–æ–º–µ—Ä]` ‚Äî –ø—Ä–æ–¥–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞"
    )
    bot.send_message(m.chat.id, welcome_text, parse_mode="Markdown")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å')
def earn(m):
    user = get_user(m)
    gain = random.randint(3000, 7000)
    with lock:
        user["balance"] += gain
        save_users()
    bot.send_message(m.chat.id, f"üî® –¢—ã –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–ª —á–µ—Ö–æ–ª –∏ –∫–∞–±–µ–ª—å: **+{gain:,}$**", parse_mode="Markdown")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–∫–∞—Ä—Ç')
def flip(m):
    user = get_user(m)
    cost = 10000
    
    if user["balance"] < cost:
        return bot.send_message(m.chat.id, f"‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥! –ù—É–∂–Ω–æ {cost:,}$")

    with lock:
        user["balance"] -= cost
        model, base_p = random.choice(REAL_PHONES)
        cond_name, mult = random.choice(list(CONDITIONS.items()))
        final_price = int(base_p * mult)
        
        item = {"full_name": model, "price": final_price, "condition": cond_name}
        user["inventory"].append(item)
        save_users()

    bot.send_message(m.chat.id, f"üéÅ **–í—ã–ø–∞–ª –ª–æ—Ç!**\n\nüì± {model}\n–°–æ—Å—Ç–æ—è–Ω–∏–µ: {cond_name}\n–†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞: {final_price:,}$", parse_mode="Markdown")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å')
def show_inv(m):
    user = get_user(m)
    if not user["inventory"]:
        return bot.send_message(m.chat.id, "üì¶ –¢–≤–æ–π —Å–∫–ª–∞–¥ –ø—É—Å—Ç. –ü–æ–∫—É–ø–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω—ã –∫–æ–º–∞–Ω–¥–æ–π `–∫–∞—Ä—Ç`!")
    
    text = "üì¶ **–¢–≤–æ–π —Å–∫–ª–∞–¥:**\n\n"
    for i, item in enumerate(user["inventory"], 1):
        text += f"{i}. {item['full_name']} ‚Äî {item['price']:,}$ ({item['condition']})\n"
    text += "\n–ß—Ç–æ–±—ã –ø—Ä–æ–¥–∞—Ç—å, –Ω–∞–ø–∏—à–∏: `–ü—Ä–æ–¥–∞—Ç—å 1`"
    bot.send_message(m.chat.id, text, parse_mode="Markdown")

@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith('–ø—Ä–æ–¥–∞—Ç—å'))
def sell(m):
    user = get_user(m)
    try:
        idx = int(m.text.split()[-1]) - 1
        with lock:
            if 0 <= idx < len(user["inventory"]):
                item = user["inventory"].pop(idx)
                # –í—ã–∫—É–ø–∞–µ–º –∑–∞ 85% –æ—Ç —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω—ã
                sell_price = int(item["price"] * 0.85)
                user["balance"] += sell_price
                save_users()
                bot.send_message(m.chat.id, f"ü§ù –°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞! **{item['full_name']}** –ø—Ä–æ–¥–∞–Ω –∑–∞ **{sell_price:,}$**", parse_mode="Markdown")
            else:
                bot.send_message(m.chat.id, "‚ùå –ù–µ—Ç —Ç–∞–∫–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.")
    except:
        bot.send_message(m.chat.id, "‚ùå –ù–∞–ø–∏—à–∏: `–ü—Ä–æ–¥–∞—Ç—å [–Ω–æ–º–µ—Ä]` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ü—Ä–æ–¥–∞—Ç—å 1)")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–ø—Ä–æ—Ñ–∏–ª—å')
def profile(m):
    user = get_user(m)
    inv_sum = sum(i["price"] for i in user["inventory"])
    msg = (f"üë§ **–ü—Ä–æ—Ñ–∏–ª—å: {user['name']}**\n"
           f"üí∞ –ë–∞–ª–∞–Ω—Å: `{user['balance']:,}$`\n"
           f"üì¶ –°—Ç–æ–∏–º–æ—Å—Ç—å —Å–∫–ª–∞–¥–∞: `{inv_sum:,}$`\n"
           f"üì± –í—Å–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: {len(user['inventory'])}")
    bot.send_message(m.chat.id, msg, parse_mode="Markdown")

if __name__ == "__main__":
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –∂–¥–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...")
    bot.infinity_polling()
