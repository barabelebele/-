import os
import time
import random
import json
import logging
from threading import Lock
import telebot

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- –¢–æ–∫–µ–Ω ---
# –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ö–æ—Å—Ç–∏–Ω–≥–∞, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –±–µ—Ä–µ–º –∏–∑ –∫–∞–≤—ã—á–µ–∫
TOKEN = os.getenv("TG_BOT_TOKEN") or "8109307891:AAHSqQtacU_Ar_1srMJisLqD1eEPEXocmls"
bot = telebot.TeleBot(TOKEN)

# --- –î–∞–Ω–Ω—ã–µ ---
REAL_PHONES = [
    ("iPhone 12", 600),
    ("Samsung Galaxy S21", 550),
    ("Xiaomi Mi 11", 400),
    ("Google Pixel 5", 380),
]

CONDITIONS = {
    "‚úÖ –ë/–£ –•–æ—Ä–æ—à–µ–µ": 0.7,
    "‚ú® –ò–¥–µ–∞–ª—å–Ω–æ–µ": 1.0,
}

USERS_FILE = "users.json"
lock = Lock()
_users = {}

def load_users():
    global _users
    try:
        if os.path.exists(USERS_FILE):
            with open(USERS_FILE, "r", encoding="utf-8") as f:
                _users = json.load(f)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã: {e}")
        _users = {}

def save_users():
    try:
        with open(USERS_FILE, "w", encoding="utf-8") as f:
            json.dump(_users, f, ensure_ascii=False, indent=2)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–∑—ã: {e}")

def get_user(m):
    uid = str(m.from_user.id)
    with lock:
        if uid not in _users:
            _users[uid] = {
                "name": m.from_user.first_name or "–ò–≥—Ä–æ–∫",
                "balance": 20000,
                "inventory": [],
                "last_flip": 0
            }
            save_users()
        return _users[uid]

load_users()

# --- –ö–æ–º–∞–Ω–¥—ã ---

@bot.message_handler(commands=['start'])
def start_cmd(m):
    bot.send_message(m.chat.id, "–ü—Ä–∏–≤–µ—Ç! –ö–æ–º–∞–Ω–¥—ã: –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å, –ø—Ä–æ—Ñ–∏–ª—å, –∫–∞—Ä—Ç, –ø—Ä–æ–¥–∞—Ç—å [–Ω–æ–º–µ—Ä]")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å')
def earn(m):
    user = get_user(m)
    gain = random.randint(5000, 15000)
    with lock:
        user["balance"] += gain
        save_users()
    bot.send_message(m.chat.id, f"üî® –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: +{gain:,}$")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–ø—Ä–æ—Ñ–∏–ª—å')
def profile(m):
    user = get_user(m)
    inv = user.get("inventory", [])
    inv_value = sum(i.get('price', 0) for i in inv)
    msg = (f"üë§ {user['name']}\n"
           f"üí∞ –ë–∞–ª–∞–Ω—Å: {user['balance']:,}$\n"
           f"üì± –°–º–∞—Ä—Ç—Ñ–æ–Ω–æ–≤: {len(inv)}\n"
           f"üìà –ö–∞–ø–∏—Ç–∞–ª: {inv_value:,}$")
    bot.send_message(m.chat.id, msg)

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–∫–∞—Ä—Ç')
def flip(m):
    user = get_user(m)
    now = time.time()
    if now - user.get("last_flip", 0) < 3600:
        return bot.send_message(m.chat.id, "‚è≥ –ï—â–µ –Ω–µ –ø—Ä–æ—à–µ–ª —á–∞—Å!")

    if user["balance"] < 10000:
        return bot.send_message(m.chat.id, "‚ùå –ù—É–∂–Ω–æ 10,000$")

    model_name, base_price = random.choice(REAL_PHONES)
    cond = random.choice(list(CONDITIONS.keys()))
    price = int(base_price * CONDITIONS[cond])
    
    with lock:
        user["balance"] -= 10000
        user["last_flip"] = now
        user["inventory"].append({"full_name": model_name, "price": price, "condition": cond})
        save_users()
    
    bot.send_message(m.chat.id, f"üéÅ –í—ã–ø–∞–ª–æ: {model_name} ({cond}) –∑–∞ {price:,}$")

@bot.message_handler(func=lambda m: m.text and m.text.lower().startswith('–ø—Ä–æ–¥–∞—Ç—å '))
def sell(m):
    try:
        idx = int(m.text.split()[-1]) - 1
        user = get_user(m)
        with lock:
            item = user["inventory"].pop(idx)
            sell_price = int(item["price"] * 0.85)
            user["balance"] += sell_price
            save_users()
        bot.send_message(m.chat.id, f"ü§ù –ü—Ä–æ–¥–∞–Ω–æ –∑–∞ {sell_price:,}$")
    except:
        bot.send_message(m.chat.id, "‚ùå –û—à–∏–±–∫–∞. –ü–∏—à–∏: –ü—Ä–æ–¥–∞—Ç—å 1")

# --- –ó–∞–ø—É—Å–∫ ---
if __name__ == "__main__":
    print("–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    bot.infinity_polling()
